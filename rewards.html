<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PrimePull.gg | Daily Spin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/rewards.css">
</head>
<body>
<script src="scripts/preloader.js"></script>
  <div id="coin-rain"></div>
  <header></header>
  <main class="relative overflow-x-hidden bg-[#080b16] text-white pb-24">
    <div class="pointer-events-none absolute inset-0">
      <div class="absolute -top-32 -left-24 h-72 w-72 rounded-full bg-indigo-500/30 blur-3xl"></div>
      <div class="absolute top-1/3 -right-16 h-80 w-80 rounded-full bg-purple-600/20 blur-3xl"></div>
      <div class="absolute bottom-0 left-1/4 h-72 w-72 rounded-full bg-blue-500/10 blur-3xl"></div>
    </div>

    <section class="relative z-10 pt-24 pb-28 text-center">
      <div class="max-w-4xl mx-auto px-6">
        <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-5 py-2 text-sm font-semibold uppercase tracking-[0.3em] text-slate-200">
          <i class="fas fa-bolt text-yellow-300"></i>
          Daily Rewards
        </span>
        <h1 class="mt-8 text-4xl sm:text-5xl lg:text-6xl font-extrabold leading-tight">
          <span class="block text-slate-100">Spin. Earn. Level Up.</span>
          <span class="mt-2 block bg-gradient-to-r from-blue-400 via-indigo-400 to-purple-400 bg-clip-text text-transparent">Claim your free loot every day</span>
        </h1>
        <p class="mt-6 text-base sm:text-lg text-slate-300">
          Open cases, complete quests, and collect coins to unlock bigger bonuses with every visit.
        </p>
      </div>

      <div class="mt-12 grid gap-4 px-6 text-left sm:grid-cols-2 lg:grid-cols-3 max-w-5xl mx-auto">
        <div class="rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur">
          <div class="flex items-center gap-3 text-indigo-300">
            <i class="fas fa-sync text-lg"></i>
            <span class="text-sm font-semibold uppercase tracking-widest">Every 24 Hours</span>
          </div>
          <p class="mt-3 text-sm text-slate-200">
            Come back daily for a guaranteed spin and stack streak bonuses as you keep the momentum going.
          </p>
        </div>
        <div class="rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur">
          <div class="flex items-center gap-3 text-indigo-300">
            <i class="fas fa-trophy text-lg"></i>
            <span class="text-sm font-semibold uppercase tracking-widest">Premium Rewards</span>
          </div>
          <p class="mt-3 text-sm text-slate-200">
            Spin for coins, gems, packs, and exclusive cosmetics curated for your activity level.
          </p>
        </div>
        <div class="rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur sm:col-span-2 lg:col-span-1">
          <div class="flex items-center gap-3 text-indigo-300">
            <i class="fas fa-dice text-lg"></i>
            <span class="text-sm font-semibold uppercase tracking-widest">Boost the Odds</span>
          </div>
          <p class="mt-3 text-sm text-slate-200">
            Opening more boxes and spending gems unlocks higher tiers on the wheel for better prizes.
          </p>
        </div>
      </div>
    </section>

    <section class="relative z-10 px-6 -mt-16">
      <div class="mx-auto grid max-w-6xl gap-6 xl:grid-cols-[minmax(0,7fr)_minmax(0,5fr)]">
        <div class="rounded-3xl border border-white/10 bg-white/5 p-6 lg:p-10 shadow-2xl backdrop-blur">
          <div class="flex flex-col gap-10 lg:flex-row lg:items-center">
            <div class="flex-1">
              <div id="wheel-wrapper" class="relative mx-auto overflow-visible">
                <div id="wheel-container">
                  <div id="wheel-rotator">
                    <canvas id="wheel" width="600" height="600"></canvas>
                    <canvas id="highlight" width="600" height="600"></canvas>
                  </div>
                  <div id="pointer"><i class="fas fa-caret-down"></i></div>
                </div>
              </div>
            </div>
            <div class="w-full max-w-xs lg:max-w-sm">
              <h2 class="text-2xl font-semibold text-white">Spin the Prime Wheel</h2>
              <p class="mt-3 text-sm text-slate-300">
                Sign in, hit the button, and watch the wheel go. Rewards are credited instantly to your balance.
              </p>
              <ul class="mt-6 space-y-3 text-sm text-slate-200">
                <li class="flex items-start gap-3">
                  <span class="mt-1 inline-flex h-6 w-6 items-center justify-center rounded-full bg-indigo-500/30 text-indigo-200"><i class="fas fa-gem text-xs"></i></span>
                  <span>Higher engagement increases the value of each segment on the wheel.</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="mt-1 inline-flex h-6 w-6 items-center justify-center rounded-full bg-indigo-500/30 text-indigo-200"><i class="fas fa-hourglass-half text-xs"></i></span>
                  <span>Premium members and admins can test spin without waiting for the daily timer.</span>
                </li>
              </ul>
              <button id="spin" class="mt-8">Spin</button>
              <p id="countdown" class="hidden mt-3"></p>
            </div>
          </div>
        </div>

        <aside class="rounded-3xl border border-white/10 bg-white/5 p-6 lg:p-8 shadow-2xl backdrop-blur">
          <h2 class="text-2xl font-semibold text-white">Weekly Quest Board</h2>
          <p class="mt-3 text-sm text-slate-300">
            Complete challenges throughout the week to earn additional coin injections and streak bonuses.
          </p>
          <div id="quest-container" class="mt-8">
            <div class="space-y-4" aria-hidden="true">
              <div class="animate-pulse rounded-2xl border border-white/10 bg-white/5 p-4"></div>
              <div class="animate-pulse rounded-2xl border border-white/10 bg-white/5 p-4"></div>
              <div class="animate-pulse rounded-2xl border border-white/10 bg-white/5 p-4"></div>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <section class="relative z-10 mt-20 px-6">
      <div class="mx-auto max-w-6xl rounded-3xl border border-white/10 bg-gradient-to-r from-white/5 via-white/10 to-white/5 p-8 lg:p-12 backdrop-blur">
        <div class="grid gap-6 lg:grid-cols-3">
          <div class="rounded-2xl border border-white/10 bg-[#0b1120]/70 p-6">
            <div class="flex items-center gap-3 text-indigo-300">
              <i class="fas fa-calendar-week text-lg"></i>
              <span class="text-sm font-semibold uppercase tracking-widest">Keep Your Streak</span>
            </div>
            <p class="mt-4 text-sm text-slate-200">
              Daily spins and weekly quests refresh automatically. Missing a day resets the timer, so stay active for the best multipliers.
            </p>
          </div>
          <div class="rounded-2xl border border-white/10 bg-[#0b1120]/70 p-6">
            <div class="flex items-center gap-3 text-indigo-300">
              <i class="fas fa-layer-group text-lg"></i>
              <span class="text-sm font-semibold uppercase tracking-widest">Rewards Tiering</span>
            </div>
            <p class="mt-4 text-sm text-slate-200">
              Your wheel adapts to your recent activity, unlocking rare cases, bonus gems, and cosmetic drops as you climb tiers.
            </p>
          </div>
          <div class="rounded-2xl border border-white/10 bg-[#0b1120]/70 p-6">
            <div class="flex items-center gap-3 text-indigo-300">
              <i class="fas fa-people-group text-lg"></i>
              <span class="text-sm font-semibold uppercase tracking-widest">Invite & Earn</span>
            </div>
            <p class="mt-4 text-sm text-slate-200">
              Share your streak with friends. Team events and seasonal promos drop here first, so check back often.
            </p>
          </div>
        </div>
      </div>
    </section>
  </main>
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 text-white hidden z-50"></div>
  <footer></footer>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCyRm6dWH-fAmfWy83zLTrPFVi9Ny8gyxE",
      authDomain: "cases-e5b4e.firebaseapp.com",
      databaseURL: "https://cases-e5b4e-default-rtdb.firebaseio.com",
      projectId: "cases-e5b4e",
      storageBucket: "cases-e5b4e.appspot.com",
      messagingSenderId: "22502548396",
      appId: "1:22502548396:web:aac335672c21f07524d009"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const rotator = document.getElementById('wheel-rotator');
    const hCanvas = document.getElementById('highlight');
    const hCtx = hCanvas.getContext('2d');
    let rewards = [];
    let currentRotation = 0; // cumulative rotation in degrees
    const defaultColors = ['#1e3a8a','#4338ca','#1e40af','#3b82f6','#2563eb','#312e81','#4f46e5','#1e3a8a'];

    function drawWheel() {
      const radius = canvas.width / 2;
      const sliceRadius = radius - 20;
      let start = -Math.PI / 2 + (currentRotation * Math.PI / 180);
      const sliceAngle = (2 * Math.PI) / rewards.length;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      rewards.forEach((r, i) => {
        r.startAngle = start;
        r.midAngle = start + sliceAngle / 2;
        r.endAngle = start + sliceAngle;
        ctx.beginPath();
        ctx.moveTo(radius, radius);
        ctx.arc(radius, radius, sliceRadius, r.startAngle, r.endAngle);
        ctx.closePath();
        ctx.fillStyle = r.color || defaultColors[i % defaultColors.length];
        ctx.fill();
        ctx.strokeStyle = '#0f0f12';
        ctx.lineWidth = 2;
        ctx.stroke();
        if (r.img && r.img.naturalWidth) {
          const imgSize = 140;
          const imgRadius = sliceRadius * 0.6;
          const cx = radius + imgRadius * Math.cos(r.midAngle);
          const cy = radius + imgRadius * Math.sin(r.midAngle);
          ctx.save();
          ctx.translate(cx, cy);
          ctx.rotate(r.midAngle + Math.PI / 2);
          ctx.drawImage(r.img, -imgSize / 2, -imgSize / 2, imgSize, imgSize);
          ctx.restore();
        }
        start += sliceAngle;
      });
      const rimGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
      rimGrad.addColorStop(0, '#facc15');
      rimGrad.addColorStop(1, '#f97316');
      ctx.beginPath();
      ctx.arc(radius, radius, sliceRadius + 12, 0, 2 * Math.PI);
      ctx.lineWidth = 8;
      ctx.strokeStyle = rimGrad;
      ctx.stroke();
      const gloss = ctx.createRadialGradient(radius, radius, 0, radius, radius, sliceRadius + 12);
      gloss.addColorStop(0, 'rgba(255,255,255,0.15)');
      gloss.addColorStop(0.85, 'rgba(255,255,255,0)');
      gloss.addColorStop(1, 'rgba(0,0,0,0.3)');
      ctx.beginPath();
      ctx.arc(radius, radius, sliceRadius + 12, 0, 2 * Math.PI);
      ctx.fillStyle = gloss;
      ctx.fill();
      const hubGrad = ctx.createRadialGradient(radius, radius, 0, radius, radius, 40);
      hubGrad.addColorStop(0, '#4b5563');
      hubGrad.addColorStop(1, '#111827');
      ctx.beginPath();
      ctx.arc(radius, radius, 40, 0, 2 * Math.PI);
      ctx.fillStyle = hubGrad;
      ctx.fill();
    }

    function spinWheel(reward) {
      const midDeg = reward.midAngle * 180 / Math.PI;
      const target = 270 - midDeg;
      const currentMod = currentRotation % 360;
      const delta = 360 * 5 + target - currentMod;
      currentRotation += delta;
      rotator.style.transition = 'transform 5s cubic-bezier(0.33, 1, 0.68, 1)';
      rotator.style.transform = `translate(-50%, -50%) rotate(${currentRotation}deg)`;
    }

    function highlightSlice(r) {
      const radius = canvas.width / 2;
      const sliceRadius = radius - 20;
      hCtx.clearRect(0, 0, hCanvas.width, hCanvas.height);
      hCtx.beginPath();
      hCtx.moveTo(radius, radius);
      hCtx.arc(radius, radius, sliceRadius, r.startAngle, r.endAngle);
      hCtx.closePath();
      hCtx.lineWidth = 8;
      hCtx.strokeStyle = '#facc15';
      hCtx.stroke();
    }

    function pickWeightedIndex(items) {
      const total = items.reduce((sum, r) => sum + (r.odds ?? r.weight ?? 1), 0);
      let rnd = Math.random() * total;
      for (let i = 0; i < items.length; i++) {
        rnd -= (items[i].odds ?? items[i].weight ?? 1);
        if (rnd < 0) return i;
      }
      return 0;
    }

    auth.onAuthStateChanged(async user => {
      const button = document.getElementById('spin');
      const countdown = document.getElementById('countdown');
      const toast = document.getElementById('toast');

      function loadRewardImage(url) {
        return new Promise(resolve => {
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = () => resolve(img);
          img.onerror = () => {
            const fallback = new Image();
            fallback.onload = () => resolve(fallback);
            fallback.onerror = () => resolve(null);
            fallback.src = url;
          };
          img.src = url;
        });
      }

      db.ref('wheelRewards').once('value').then(async snap => {
        rewards = Object.values(snap.val() || {});
        await Promise.all(
          rewards.map(async r => {
            if (!r.image) return;
            r.img = await loadRewardImage(r.image);
          })
        );
        if (rewards.length) drawWheel();
      });

      if (!user) {
        button.textContent = 'Sign In to Spin';
        button.onclick = () => location.href = 'auth.html';
        return;
      }

      const userRef = db.ref('users/' + user.uid);
      const snapshot = await userRef.once('value');
      const data = snapshot.val() || {};
      let balance = data.balance || 0;
      const lastSpin = data.lastWheelSpin || 0;
      const delay = 24 * 60 * 60 * 1000;
      const isAdmin = data.role === 'admin';

      if (!isAdmin && Date.now() - lastSpin < delay) {
        button.disabled = true;
        countdown.classList.remove('hidden');
        setInterval(() => {
          const remaining = delay - (Date.now() - lastSpin);
          if (remaining <= 0) return location.reload();
          const h = Math.floor(remaining / 3600000);
          const m = Math.floor((remaining % 3600000) / 60000);
          const s = Math.floor((remaining % 60000) / 1000);
          countdown.innerText = `Next spin in ${h}h ${m}m ${s}s`;
        }, 1000);
      }

      button.onclick = () => {
        const now = Date.now();
        if (!rewards.length || (!isAdmin && now - lastSpin < delay)) return;
        hCtx.clearRect(0, 0, hCanvas.width, hCanvas.height);
        const index = pickWeightedIndex(rewards);
        const reward = rewards[index];
        spinWheel(reward);
        button.disabled = true;
        rotator.addEventListener('transitionend', async () => {
          rotator.style.transition = 'none';
          currentRotation = currentRotation % 360;
          rotator.style.transform = `translate(-50%, -50%) rotate(${currentRotation}deg)`;
          highlightSlice(reward);
          balance += reward.amount;
          const updates = { balance };
          if (!isAdmin) updates.lastWheelSpin = now;
          await userRef.update(updates);
          toast.innerHTML = `âœ… You won ${reward.label} <img src="https://cdn-icons-png.flaticon.com/128/6369/6369589.png" class="inline w-4 h-4 coin-icon" alt="Coins">!`;
          toast.classList.remove('hidden');
          setTimeout(() => toast.classList.add('hidden'), 3000);
          if (isAdmin) button.disabled = false;
        }, { once: true });
      };
    });
  </script>
  <script type="module">
    import { renderWeeklyQuests } from './scripts/quests.js';
    firebase.auth().onAuthStateChanged(user => {
      if (user) renderWeeklyQuests();
    });
  </script>
  <script src="scripts/header.js"></script>
  <script src="scripts/navbar.js"></script>
  <script src="scripts/footer.js"></script>
  <script src="scripts/topup.js"></script>
  <script>
    function createCoin() {
      const coin = document.createElement('img');
      coin.src = 'https://cdn-icons-png.flaticon.com/128/6369/6369589.png';
      coin.className = 'coin';
      coin.style.left = Math.random() * 100 + 'vw';
      const duration = 4 + Math.random() * 3;
      coin.style.animationDuration = duration + 's';
      document.getElementById('coin-rain').appendChild(coin);
      setTimeout(() => coin.remove(), duration * 1000);
    }
    setInterval(createCoin, 400);
  </script>
</body>
</html>
