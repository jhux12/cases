<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PrimePull.gg | Daily Spin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #0f0f12, #1a1a2e);
      font-family: 'Poppins', sans-serif;
      color: white;
      overflow-x: hidden;
    }
    #wheel-container {
      position: relative;
      width: 100%;
      height: 50vh;
      overflow: hidden;
    }
    #wheel {
      width: 600px;
      height: 600px;
      position: absolute;
      left: 50%;
      bottom: -300px;
      transform: translateX(-50%);
      transition: transform 5s cubic-bezier(.17,.67,.39,1.19);
    }
    #pointer {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      font-size: 2rem;
      color: #fbbf24;
    }
  </style>
</head>
<body>
<script src="scripts/preloader.js"></script>
  <header></header>
  <main class="min-h-screen flex flex-col items-center pt-32">
    <div id="wheel-container" class="w-full flex justify-center">
      <canvas id="wheel" width="600" height="600"></canvas>
      <div id="pointer"><i class="fas fa-caret-down"></i></div>
    </div>
    <button id="spin" class="mt-8 bg-yellow-400 hover:bg-yellow-300 text-black font-bold px-8 py-3 rounded-full">Spin</button>
    <p id="countdown" class="text-yellow-400 mt-2 hidden"></p>
    <section id="quest-container" class="w-full max-w-4xl mt-12"></section>
  </main>
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl hidden z-50"></div>
  <footer></footer>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCyRm6dWH-fAmfWy83zLTrPFVi9Ny8gyxE",
      authDomain: "cases-e5b4e.firebaseapp.com",
      databaseURL: "https://cases-e5b4e-default-rtdb.firebaseio.com",
      projectId: "cases-e5b4e",
      storageBucket: "cases-e5b4e.appspot.com",
      messagingSenderId: "22502548396",
      appId: "1:22502548396:web:aac335672c21f07524d009"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    let rewards = [];
    let currentRotation = 0;

    function drawWheel() {
      const radius = canvas.width / 2;
      const angle = (2 * Math.PI) / rewards.length;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      rewards.forEach((r, i) => {
        ctx.beginPath();
        ctx.moveTo(radius, radius);
        ctx.arc(radius, radius, radius, i * angle, (i + 1) * angle);
        ctx.fillStyle = `hsl(${(i / rewards.length) * 360},70%,50%)`;
        ctx.fill();
        ctx.save();
        ctx.translate(radius, radius);
        ctx.rotate(i * angle + angle / 2);
        ctx.fillStyle = '#fff';
        ctx.font = '20px Poppins';
        ctx.textAlign = 'right';
        ctx.fillText(r.label, radius - 10, 10);
        ctx.restore();
      });
    }

    function spinWheel(index) {
      const slice = 360 / rewards.length;
      const target = 270 - (index * slice + slice / 2);
      currentRotation += 360 * 5;
      canvas.style.transform = `rotate(${currentRotation + target}deg)`;
    }

    auth.onAuthStateChanged(async user => {
      if (!user) return window.location.href = 'auth.html';
      const userRef = db.ref('users/' + user.uid);
      const snapshot = await userRef.once('value');
      const data = snapshot.val() || {};
      let balance = data.balance || 0;
      const lastSpin = data.lastWheelSpin || 0;
      const delay = 24 * 60 * 60 * 1000;
      const isAdmin = data.role === 'admin';

      db.ref('wheelRewards').once('value').then(snap => {
        rewards = Object.values(snap.val() || {});
        if (rewards.length) drawWheel();
      });

      const button = document.getElementById('spin');
      const countdown = document.getElementById('countdown');
      const toast = document.getElementById('toast');

      if (!isAdmin && Date.now() - lastSpin < delay) {
        button.disabled = true;
        countdown.classList.remove('hidden');
        setInterval(() => {
          const remaining = delay - (Date.now() - lastSpin);
          if (remaining <= 0) return location.reload();
          const h = Math.floor(remaining / 3600000);
          const m = Math.floor((remaining % 3600000) / 60000);
          const s = Math.floor((remaining % 60000) / 1000);
          countdown.innerText = `Next spin in ${h}h ${m}m ${s}s`;
        }, 1000);
      }

      button.onclick = () => {
        const now = Date.now();
        if (!rewards.length || (!isAdmin && now - lastSpin < delay)) return;
        const index = Math.floor(Math.random() * rewards.length);
        spinWheel(index);
        button.disabled = true;
        canvas.addEventListener('transitionend', async () => {
          const reward = rewards[index];
          balance += reward.amount;
          const updates = { balance };
          if (!isAdmin) updates.lastWheelSpin = now;
          await userRef.update(updates);
          toast.innerText = `âœ… You won ${reward.label}!`;
          toast.classList.remove('hidden');
          setTimeout(() => toast.classList.add('hidden'), 3000);
          if (isAdmin) button.disabled = false;
        }, { once: true });
      };
    });
  </script>
  <script type="module">
    import { renderWeeklyQuests } from './scripts/quests.js';
    firebase.auth().onAuthStateChanged(user => {
      if (user) renderWeeklyQuests();
    });
  </script>
  <script src="scripts/header.js"></script>
  <script src="scripts/navbar.js"></script>
  <script src="scripts/footer.js"></script>
  <script src="scripts/topup.js"></script>
</body>
</html>
