<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PrimePull.gg | Admin Control Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="config/app-config.js"></script>
  <script src="scripts/runtime-config.js"></script>
  <script src="scripts/firebase-config.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    const firestore = firebase.firestore();
    const allowedAdmins = [
      "jhuxf12@outlook.com"
    ];
  </script>
  <style>
    :root {
      color-scheme: dark;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: radial-gradient(circle at top, rgba(40, 32, 70, 0.55), transparent 65%), #0b1220;
      min-height: 100vh;
      color: #e2e8f0;
    }

    .glass-card {
      background: rgba(11, 18, 32, 0.88);
      border: 1px solid rgba(148, 163, 184, 0.14);
      border-radius: 1.25rem;
      padding: 1.5rem;
      box-shadow: 0 25px 60px rgba(8, 15, 35, 0.45);
      backdrop-filter: blur(12px);
    }

    .glass-subcard {
      background: rgba(15, 23, 42, 0.82);
      border: 1px solid rgba(148, 163, 184, 0.12);
      border-radius: 1rem;
      padding: 1.25rem;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      border-radius: 0.85rem;
      border: 1px solid rgba(148, 163, 184, 0.18);
      background-color: rgba(15, 23, 42, 0.9);
      padding: 0.7rem 0.95rem;
      color: #f8fafc;
      font-size: 0.92rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: rgba(168, 85, 247, 0.7);
      box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.18);
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }

    .admin-nav-link {
      display: flex;
      align-items: center;
      gap: 0.85rem;
      width: 100%;
      padding: 0.85rem 1rem;
      border-radius: 0.95rem;
      font-weight: 500;
      font-size: 0.92rem;
      color: rgba(226, 232, 240, 0.7);
      transition: all 0.25s ease;
    }

    .admin-nav-link:hover {
      color: #f8fafc;
      background: rgba(148, 163, 184, 0.14);
    }

    .admin-nav-link.active {
      background: linear-gradient(120deg, rgba(129, 140, 248, 0.6), rgba(236, 72, 153, 0.65));
      color: #ffffff;
      box-shadow: 0 12px 30px rgba(129, 140, 248, 0.35);
    }

    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    #toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.9), rgba(16, 185, 129, 0.9));
      color: white;
      padding: 0.85rem 1.4rem;
      border-radius: 999px;
      display: none;
      z-index: 1000;
      font-weight: 600;
      box-shadow: 0 20px 45px rgba(14, 159, 110, 0.45);
    }

    table thead tr {
      background: rgba(148, 163, 184, 0.12);
    }

    table tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.55);
    }
  </style>
</head>
<body class="text-slate-100">
  <script src="scripts/preloader.js"></script>
  <div id="toast"></div>
  <div class="min-h-screen flex">
    <aside class="hidden lg:flex lg:flex-col lg:w-72 xl:w-80 border-r border-slate-800/60 bg-slate-950/70 backdrop-blur-xl">
      <div class="px-6 pt-8 pb-6">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-2xl bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 text-lg font-bold">P</span>
          <div>
            <p class="text-sm uppercase tracking-widest text-slate-400">PrimePull.gg</p>
            <h1 class="text-xl font-semibold text-white">Admin Control Center</h1>
          </div>
        </div>
      </div>
      <nav class="flex-1 px-4 space-y-1">
        <button type="button" data-section="overview" class="admin-nav-link active"><i class="fa-solid fa-chart-line"></i>Overview</button>
        <button type="button" data-section="cases" class="admin-nav-link"><i class="fa-solid fa-box-open"></i>Cases & Pick'em</button>
        <button type="button" data-section="shipments" class="admin-nav-link"><i class="fa-solid fa-truck"></i>Shipments</button>
        <button type="button" data-section="support" class="admin-nav-link"><i class="fa-solid fa-inbox"></i>Support Inbox</button>
        <button type="button" data-section="users" class="admin-nav-link"><i class="fa-solid fa-users"></i>User Directory</button>
        <button type="button" data-section="marketplace" class="admin-nav-link"><i class="fa-solid fa-store"></i>Marketplace</button>
        <button type="button" data-section="quests" class="admin-nav-link"><i class="fa-solid fa-list-check"></i>Weekly Quests</button>
        <button type="button" data-section="rewards" class="admin-nav-link"><i class="fa-solid fa-circle-notch"></i>Rewards Wheel</button>
      </nav>
      <div class="px-6 py-6 border-t border-slate-800/60">
        <button id="logout-button" type="button" class="w-full inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-rose-500 to-purple-500 py-3 font-semibold text-sm">
          <i class="fa-solid fa-arrow-right-from-bracket"></i> Sign out
        </button>
      </div>
    </aside>
    <div class="flex-1 flex flex-col min-h-screen">
      <header class="sticky top-0 z-30 bg-slate-950/85 backdrop-blur-xl border-b border-slate-800/70">
        <div class="px-4 sm:px-6 lg:px-10 py-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div class="space-y-1">
            <p class="text-xs uppercase tracking-[0.35em] text-slate-400">PrimePull.gg</p>
            <h2 class="text-2xl font-semibold text-white">Operations Dashboard</h2>
          </div>
          <div class="flex items-center gap-3">
            <div class="relative flex-1 max-w-xs">
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-sm"></i>
              <input id="global-user-search" type="search" placeholder="Quick user lookup‚Ä¶" class="form-input pl-9 pr-4 text-sm" />
            </div>
            <button type="button" data-section="overview" class="inline-flex items-center gap-2 rounded-xl bg-slate-800/80 px-4 py-2 text-sm font-medium text-slate-200 hover:bg-slate-700/80 lg:hidden">
              <i class="fa-solid fa-border-all"></i> Menu
            </button>
          </div>
        </div>
        <div class="px-4 sm:px-6 pb-4 lg:hidden">
          <div class="flex gap-2 overflow-x-auto hide-scrollbar">
            <button type="button" data-section="overview" class="admin-nav-link active"><i class="fa-solid fa-chart-line"></i>Overview</button>
            <button type="button" data-section="cases" class="admin-nav-link"><i class="fa-solid fa-box-open"></i>Cases</button>
            <button type="button" data-section="shipments" class="admin-nav-link"><i class="fa-solid fa-truck"></i>Shipments</button>
            <button type="button" data-section="support" class="admin-nav-link"><i class="fa-solid fa-inbox"></i>Support</button>
            <button type="button" data-section="users" class="admin-nav-link"><i class="fa-solid fa-users"></i>Users</button>
          </div>
        </div>
      </header>
      <main id="admin-panel" class="flex-1 overflow-y-auto" style="display: none;">
        <div class="px-4 sm:px-6 lg:px-10 py-10 space-y-16">
          <section id="overview-section" class="space-y-10">
            <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-6">
              <div class="space-y-2">
                <h2 class="text-3xl font-bold text-white tracking-tight">Good to see you back, Admin üëã</h2>
                <p class="text-slate-400 text-sm md:text-base max-w-2xl">
                  Monitor platform health at a glance, jump into common workflows, and keep the drops flowing.
                </p>
              </div>
              <div class="glass-card flex items-center gap-4 max-w-xs">
                <div class="h-12 w-12 flex items-center justify-center rounded-2xl bg-gradient-to-br from-purple-500 via-indigo-500 to-sky-500 text-2xl">
                  <i class="fa-solid fa-signal"></i>
                </div>
                <div>
                  <p class="text-xs uppercase tracking-widest text-slate-400">Platform uptime</p>
                  <p class="text-lg font-semibold text-emerald-400">Operational</p>
                </div>
              </div>
            </div>

            <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
              <div class="glass-card space-y-2">
                <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Standard Cases</p>
                <p id="stat-total-cases" class="text-4xl font-bold text-white">--</p>
                <p class="text-sm text-slate-400">Active public cases available to players.</p>
              </div>
              <div class="glass-card space-y-2">
                <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Pick'em Pools</p>
                <p id="stat-pickem-cases" class="text-4xl font-bold text-white">--</p>
                <p class="text-sm text-slate-400">Special Pick'em / Vault experiences live now.</p>
              </div>
              <div class="glass-card space-y-2">
                <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Shipments Queue</p>
                <p id="stat-shipments-pending" class="text-4xl font-bold text-white">--</p>
                <p class="text-sm text-slate-400">Awaiting approval or fulfillment.</p>
              </div>
              <div class="glass-card space-y-2">
                <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Support Workload</p>
                <p id="stat-support-open" class="text-4xl font-bold text-white">--</p>
                <p class="text-sm text-slate-400">Open conversations needing a reply.</p>
              </div>
              <div class="glass-card space-y-2">
                <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Marketplace Items</p>
                <p id="stat-market-items" class="text-4xl font-bold text-white">--</p>
                <p class="text-sm text-slate-400">Live buyable inventory entries.</p>
              </div>
              <div class="glass-card space-y-2">
                <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Users</p>
                <p id="stat-total-users" class="text-4xl font-bold text-white">--</p>
                <p class="text-sm text-slate-400">Total accounts indexed in Firebase.</p>
              </div>
            </div>

            <div class="grid gap-6 xl:grid-cols-3">
              <div class="glass-card space-y-4 xl:col-span-2">
                <div class="flex flex-wrap items-center justify-between gap-3">
                  <h3 class="text-lg font-semibold text-white">Quick actions</h3>
                  <p class="text-xs uppercase tracking-[0.25em] text-slate-500">Work smarter</p>
                </div>
                <div class="grid gap-3 sm:grid-cols-2 xl:grid-cols-3">
                  <button type="button" data-section="cases" class="glass-subcard flex items-center gap-3 hover:border-purple-500/50 hover:bg-purple-500/10 transition" onclick="showSection('cases'); document.getElementById('case-name').focus();">
                    <span class="h-10 w-10 flex items-center justify-center rounded-xl bg-purple-500/20 text-purple-200 text-lg"><i class="fa-solid fa-plus"></i></span>
                    <div class="text-left">
                      <p class="text-sm font-semibold text-white">Add new case</p>
                      <p class="text-xs text-slate-400">Launch a fresh drop in seconds.</p>
                    </div>
                  </button>
                  <button type="button" data-section="shipments" class="glass-subcard flex items-center gap-3 hover:border-sky-500/50 hover:bg-sky-500/10 transition" onclick="showSection('shipments');">
                    <span class="h-10 w-10 flex items-center justify-center rounded-xl bg-sky-500/20 text-sky-200 text-lg"><i class="fa-solid fa-clipboard-check"></i></span>
                    <div class="text-left">
                      <p class="text-sm font-semibold text-white">Review shipments</p>
                      <p class="text-xs text-slate-400">Approve and fulfill pending orders.</p>
                    </div>
                  </button>
                  <button type="button" data-section="support" class="glass-subcard flex items-center gap-3 hover:border-emerald-500/50 hover:bg-emerald-500/10 transition" onclick="showSection('support');">
                    <span class="h-10 w-10 flex items-center justify-center rounded-xl bg-emerald-500/20 text-emerald-200 text-lg"><i class="fa-solid fa-headset"></i></span>
                    <div class="text-left">
                      <p class="text-sm font-semibold text-white">Inbox follow-up</p>
                      <p class="text-xs text-slate-400">Respond to the latest support tickets.</p>
                    </div>
                  </button>
                  <button type="button" data-section="marketplace" class="glass-subcard flex items-center gap-3 hover:border-amber-500/50 hover:bg-amber-500/10 transition" onclick="showSection('marketplace'); document.getElementById('market-name').focus();">
                    <span class="h-10 w-10 flex items-center justify-center rounded-xl bg-amber-500/20 text-amber-200 text-lg"><i class="fa-solid fa-cart-plus"></i></span>
                    <div class="text-left">
                      <p class="text-sm font-semibold text-white">Add marketplace card</p>
                      <p class="text-xs text-slate-400">Keep the store stocked with heat.</p>
                    </div>
                  </button>
                  <button type="button" class="glass-subcard flex items-center gap-3 hover:border-rose-500/50 hover:bg-rose-500/10 transition" id="clear-battles">
                    <span class="h-10 w-10 flex items-center justify-center rounded-xl bg-rose-500/20 text-rose-200 text-lg"><i class="fa-solid fa-fire-extinguisher"></i></span>
                    <div class="text-left">
                      <p class="text-sm font-semibold text-white">Clear stuck battles</p>
                      <p class="text-xs text-slate-400">Reset unfinished battle records.</p>
                    </div>
                  </button>
                  <button type="button" data-section="quests" class="glass-subcard flex items-center gap-3 hover:border-indigo-500/50 hover:bg-indigo-500/10 transition" onclick="showSection('quests');">
                    <span class="h-10 w-10 flex items-center justify-center rounded-xl bg-indigo-500/20 text-indigo-200 text-lg"><i class="fa-solid fa-bullseye"></i></span>
                    <div class="text-left">
                      <p class="text-sm font-semibold text-white">Tune weekly quests</p>
                      <p class="text-xs text-slate-400">Update goals & rewards instantly.</p>
                    </div>
                  </button>
                </div>
              </div>
              <div class="glass-card space-y-4">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-white">Realtime sync</h3>
                  <span class="text-xs uppercase tracking-[0.25em] text-slate-500">Firebase</span>
                </div>
                <ul class="space-y-3 text-sm">
                  <li class="flex items-center justify-between">
                    <span class="text-slate-300">Cases</span>
                    <span id="sync-cases" class="rounded-full bg-slate-900/70 px-3 py-1 text-xs text-slate-400">--</span>
                  </li>
                  <li class="flex items-center justify-between">
                    <span class="text-slate-300">Shipments</span>
                    <span id="sync-shipments" class="rounded-full bg-slate-900/70 px-3 py-1 text-xs text-slate-400">--</span>
                  </li>
                  <li class="flex items-center justify-between">
                    <span class="text-slate-300">Support</span>
                    <span id="sync-support" class="rounded-full bg-slate-900/70 px-3 py-1 text-xs text-slate-400">--</span>
                  </li>
                  <li class="flex items-center justify-between">
                    <span class="text-slate-300">Marketplace</span>
                    <span id="sync-marketplace" class="rounded-full bg-slate-900/70 px-3 py-1 text-xs text-slate-400">--</span>
                  </li>
                </ul>
              </div>
            </div>

            <div class="glass-card space-y-5">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-lg font-semibold text-white">Homepage spinner</h3>
                  <p class="text-xs text-slate-400">Choose which pack anchors the hero reel on the homepage.</p>
                </div>
                <span class="text-xs uppercase tracking-[0.3em] text-indigo-300">Hero spotlight</span>
              </div>
              <form id="home-spinner-form" class="space-y-4">
                <div class="space-y-2">
                  <label for="home-spinner-pack" class="text-xs font-semibold uppercase tracking-wide text-slate-400">Featured pack</label>
                  <select id="home-spinner-pack" class="form-select">
                    <option value="">Select a pack‚Ä¶</option>
                  </select>
                </div>
                <div id="home-spinner-preview" class="flex items-center gap-3 rounded-xl border border-slate-700/80 bg-slate-900/40 p-3">
                  <img id="home-spinner-image" src="" alt="Pack preview" class="h-16 w-16 rounded-xl object-cover hidden">
                  <div>
                    <p id="home-spinner-title" class="text-sm font-semibold text-white">No pack selected</p>
                    <p id="home-spinner-subtitle" class="text-xs text-slate-400">Choose a pack to update the homepage spinner.</p>
                  </div>
                </div>
                <div class="flex justify-end">
                  <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 px-5 py-2 text-sm font-semibold">
                    <i class="fa-solid fa-floppy-disk"></i> Save featured pack
                  </button>
                </div>
              </form>
            </div>

            <div class="grid gap-6 lg:grid-cols-2">
              <div class="glass-card space-y-4">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-white">High performing drops</h3>
                  <span class="text-xs uppercase tracking-[0.25em] text-slate-500">Live picks</span>
                </div>
                <div id="overview-case-highlights" class="space-y-3 text-sm text-slate-300">
                  <p class="text-slate-500">Loading drops‚Ä¶</p>
                </div>
              </div>
              <div class="glass-card space-y-4">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-white">Support inbox snapshot</h3>
                  <button type="button" class="text-xs font-semibold uppercase tracking-[0.3em] text-purple-300" onclick="showSection('support');">View all</button>
                </div>
                <div id="recent-support" class="space-y-3 text-sm text-slate-300">
                  <p class="text-slate-500">No support requests yet.</p>
                </div>
              </div>
            </div>
          </section>
          <section id="cases-section" class="hidden space-y-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div>
                <h2 class="text-3xl font-semibold text-white">Cases & Pick'em management</h2>
                <p class="text-slate-400 text-sm max-w-2xl">Curate, edit, and launch new experiences with full control over pricing, tagging, and prize pools.</p>
              </div>
              <div class="relative max-w-sm w-full">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
                <input id="case-search" type="search" placeholder="Search cases‚Ä¶" class="form-input pl-11" />
              </div>
            </div>

            <div class="grid gap-6 xl:grid-cols-3">
              <div class="glass-card space-y-4 xl:col-span-2">
                <div class="flex flex-wrap items-center justify-between gap-3">
                  <h3 class="text-lg font-semibold text-white">Live standard cases</h3>
                  <span class="text-xs uppercase tracking-[0.3em] text-slate-500">Realtime</span>
                </div>
                <div id="case-list" class="space-y-4"></div>
              </div>
              <div class="glass-card space-y-4">
                <div class="flex flex-wrap items-center justify-between gap-3">
                  <h3 class="text-lg font-semibold text-white">Pick'em vaults</h3>
                  <span class="text-xs uppercase tracking-[0.3em] text-slate-500">Premium</span>
                </div>
                <div id="vault-list" class="space-y-4"></div>
              </div>
            </div>

            <div class="glass-card space-y-6">
              <div class="flex flex-wrap items-center justify-between gap-3">
                <h3 id="form-title" class="text-2xl font-semibold text-white">Add a new case</h3>
                <span class="text-xs uppercase tracking-[0.3em] text-slate-500">Creation studio</span>
              </div>
              <form id="case-form" class="space-y-6">
                <input type="hidden" id="case-id">
                <input type="hidden" id="case-path">

                <div class="grid gap-6 lg:grid-cols-2">
                  <div class="space-y-5">
                    <div class="space-y-2">
                      <label class="text-sm font-medium text-slate-300">Case name</label>
                      <input type="text" id="case-name" class="form-input" placeholder="Legendary drip" />
                    </div>
                    <div class="space-y-2">
                      <label class="text-sm font-medium text-slate-300">Case price (USD)</label>
                      <input type="number" id="case-price" class="form-input" placeholder="49.99" step="0.01" min="0" />
                    </div>
                    <div class="grid gap-3 sm:grid-cols-2">
                      <label class="inline-flex items-center gap-3 rounded-xl border border-slate-800/80 bg-slate-900/60 px-4 py-3 text-sm text-slate-300">
                        <input type="checkbox" id="case-free" class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-purple-500 focus:ring-purple-400" />
                        Free case (price becomes 0)
                      </label>
                      <label class="inline-flex items-center gap-3 rounded-xl border border-slate-800/80 bg-slate-900/60 px-4 py-3 text-sm text-slate-300">
                        <input type="checkbox" id="case-vault" class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-purple-500 focus:ring-purple-400" />
                        Enable Pick'em mode
                      </label>
                    </div>
                    <div class="space-y-2">
                      <label class="text-sm font-medium text-slate-300">Case badge</label>
                      <input type="text" id="case-tag" class="form-input" placeholder="üî• Hot drop" />
                    </div>
                    <div class="space-y-2">
                      <label class="text-sm font-medium text-slate-300">Spice level</label>
                      <select id="case-spice" class="form-select">
                        <option value="">None</option>
                        <option value="easy">üå∂Ô∏è Easy</option>
                        <option value="medium">üå∂Ô∏èüå∂Ô∏è Medium</option>
                        <option value="hard">üå∂Ô∏èüå∂Ô∏èüå∂Ô∏è Hard</option>
                      </select>
                    </div>
                    <div class="space-y-2">
                      <p class="text-sm font-medium text-slate-300">Categories</p>
                      <div class="grid gap-3 sm:grid-cols-3">
                        <label class="inline-flex items-center gap-2 rounded-xl border border-slate-800/80 bg-slate-900/60 px-4 py-3 text-xs uppercase tracking-wide text-slate-300">
                          <input type="checkbox" id="case-new" class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-purple-500 focus:ring-purple-400" />
                          New
                        </label>
                        <label class="inline-flex items-center gap-2 rounded-xl border border-slate-800/80 bg-slate-900/60 px-4 py-3 text-xs uppercase tracking-wide text-slate-300">
                          <input type="checkbox" id="case-featured" class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-purple-500 focus:ring-purple-400" />
                          Featured
                        </label>
                        <label class="inline-flex items-center gap-2 rounded-xl border border-slate-800/80 bg-slate-900/60 px-4 py-3 text-xs uppercase tracking-wide text-slate-300">
                          <input type="checkbox" id="case-starter" class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-purple-500 focus:ring-purple-400" />
                          Starter
                        </label>
                      </div>
                    </div>
                  </div>
                  <div class="space-y-5">
                    <div class="space-y-2">
                      <label class="text-sm font-medium text-slate-300">Feature image URL</label>
                      <input type="text" id="case-image" class="form-input" placeholder="https://‚Ä¶" oninput="previewImage(this.value)" />
                      <p class="text-xs text-slate-500">High-resolution square artwork performs best.</p>
                    </div>
                    <div class="glass-subcard flex items-center justify-center min-h-[160px] border-dashed border-2 border-slate-700/60">
                      <img id="image-preview" src="" alt="Preview" class="hidden h-28 w-28 rounded-xl object-cover shadow-lg shadow-purple-900/50" />
                      <p class="text-sm text-slate-500" id="image-placeholder">Artwork preview appears here.</p>
                    </div>
                    <div id="card-back-wrapper" class="space-y-2 hidden">
                      <label class="text-sm font-medium text-slate-300">Card back image URL</label>
                      <input type="text" id="case-card-back" class="form-input" placeholder="https://‚Ä¶" />
                    </div>
                  </div>
                </div>

                <div id="prizes-section" class="space-y-4">
                  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                    <h3 class="text-sm font-semibold uppercase tracking-[0.35em] text-slate-300">Prize pools</h3>
                    <span class="text-xs text-slate-500">Odds should total 100%</span>
                  </div>
                  <button type="button" onclick="addPrize()" class="add-prize-btn inline-flex items-center gap-2 rounded-xl bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-200 hover:bg-emerald-500/30">
                    <i class="fa-solid fa-plus"></i> Add prize
                  </button>
                </div>

                <div class="flex flex-wrap items-center justify-end gap-3 pt-2">
                  <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-purple-500 via-indigo-500 to-sky-500 px-6 py-3 text-sm font-semibold shadow-lg shadow-purple-900/40">
                    <i class="fa-solid fa-floppy-disk"></i> Save case
                  </button>
                  <button type="button" id="cancel-edit" class="inline-flex items-center gap-2 rounded-xl border border-slate-700/80 px-6 py-3 text-sm font-semibold text-slate-300 hover:bg-slate-800/80 hidden">
                    <i class="fa-solid fa-rotate-left"></i> Cancel edit
                  </button>
                </div>
              </form>
            </div>
          </section>
          <section id="marketplace-section" class="hidden space-y-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div>
                <h2 class="text-3xl font-semibold text-white">Marketplace management</h2>
                <p class="text-slate-400 text-sm max-w-2xl">List new collectibles, adjust valuations, and curate the live storefront.</p>
              </div>
            </div>
            <div class="grid gap-6 lg:grid-cols-2">
              <div class="glass-card space-y-5">
                <div class="flex items-center justify-between">
                  <h3 id="marketplace-form-title" class="text-xl font-semibold text-white">Add marketplace product</h3>
                  <span class="text-xs uppercase tracking-[0.3em] text-slate-500">Storefront</span>
                </div>
                <form id="marketplace-form" class="space-y-4">
                  <div class="space-y-2">
                    <label class="text-sm font-medium text-slate-300">Card name</label>
                    <input type="text" id="market-name" class="form-input" placeholder="Radiant Splash" required />
                  </div>
                  <div class="space-y-2">
                    <label class="text-sm font-medium text-slate-300">Image URL</label>
                    <input type="text" id="market-image" class="form-input" placeholder="https://‚Ä¶" required />
                  </div>
                  <div class="grid gap-4 md:grid-cols-2">
                    <div class="space-y-2">
                      <label class="text-sm font-medium text-slate-300">Value (gems)</label>
                      <input type="number" id="market-value" class="form-input" placeholder="500" min="0" required />
                    </div>
                    <div class="space-y-2">
                      <label class="text-sm font-medium text-slate-300">Rarity</label>
                      <select id="market-rarity" class="form-select">
                        <option value="common">Common</option>
                        <option value="uncommon">Uncommon</option>
                        <option value="rare">Rare</option>
                        <option value="ultra rare">Ultra Rare</option>
                        <option value="legendary">Legendary</option>
                      </select>
                    </div>
                  </div>
                  <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-amber-500 to-rose-500 px-5 py-3 text-sm font-semibold shadow-lg shadow-amber-900/40">
                    <i class="fa-solid fa-cart-plus"></i>
                    <span>Add product</span>
                  </button>
                </form>
              </div>
              <div class="glass-card space-y-4">
                <div class="flex items-center justify-between">
                  <h3 class="text-xl font-semibold text-white">Live marketplace</h3>
                  <span class="text-xs uppercase tracking-[0.3em] text-slate-500">Realtime</span>
                </div>
                <div id="market-list" class="space-y-4"></div>
              </div>
            </div>
          </section>

          <section id="quests-section" class="hidden space-y-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div>
                <h2 class="text-3xl font-semibold text-white">Weekly quest configuration</h2>
                <p class="text-slate-400 text-sm max-w-2xl">Set engagement goals and automate the payout structure for recurring missions.</p>
              </div>
            </div>
            <div class="glass-card">
              <form id="quest-config-form" class="space-y-6">
                <div class="grid gap-6 md:grid-cols-3">
                  <div class="glass-subcard space-y-3">
                    <h3 class="text-sm uppercase tracking-[0.35em] text-slate-400">Open packs</h3>
                    <div class="space-y-2">
                      <label class="text-xs font-semibold uppercase tracking-wide text-slate-400">Goal</label>
                      <input type="number" id="openPacks-goal" class="form-input" min="0" />
                    </div>
                    <div class="space-y-2">
                      <label class="text-xs font-semibold uppercase tracking-wide text-slate-400">Reward (gems)</label>
                      <input type="number" id="openPacks-reward" class="form-input" min="0" />
                    </div>
                  </div>
                  <div class="glass-subcard space-y-3">
                    <h3 class="text-sm uppercase tracking-[0.35em] text-slate-400">Spend gems</h3>
                    <div class="space-y-2">
                      <label class="text-xs font-semibold uppercase tracking-wide text-slate-400">Goal</label>
                      <input type="number" id="spendCoins-goal" class="form-input" min="0" />
                    </div>
                    <div class="space-y-2">
                      <label class="text-xs font-semibold uppercase tracking-wide text-slate-400">Reward (gems)</label>
                      <input type="number" id="spendCoins-reward" class="form-input" min="0" />
                    </div>
                  </div>
                  <div class="glass-subcard space-y-3">
                    <h3 class="text-sm uppercase tracking-[0.35em] text-slate-400">Pull rares</h3>
                    <div class="space-y-2">
                      <label class="text-xs font-semibold uppercase tracking-wide text-slate-400">Goal</label>
                      <input type="number" id="pullRare-goal" class="form-input" min="0" />
                    </div>
                    <div class="space-y-2">
                      <label class="text-xs font-semibold uppercase tracking-wide text-slate-400">Reward (gems)</label>
                      <input type="number" id="pullRare-reward" class="form-input" min="0" />
                    </div>
                  </div>
                </div>
                <div class="flex justify-end">
                  <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-emerald-500 to-sky-500 px-6 py-3 text-sm font-semibold shadow-lg shadow-emerald-900/40">
                    <i class="fa-solid fa-circle-check"></i> Save quest config
                  </button>
                </div>
              </form>
            </div>
          </section>

          <section id="rewards-section" class="hidden space-y-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div>
                <h2 class="text-3xl font-semibold text-white">Rewards wheel editor</h2>
                <p class="text-slate-400 text-sm max-w-2xl">Curate the spin rewards, customize colors, and dial in the drop odds.</p>
              </div>
            </div>
            <div class="glass-card space-y-5">
              <form id="wheel-form" class="space-y-5">
                <div id="wheel-rewards" class="space-y-4"></div>
                <div class="flex flex-wrap items-center justify-between gap-3">
                  <button type="button" id="add-reward" class="inline-flex items-center gap-2 rounded-xl bg-sky-500/20 px-4 py-2 text-sm font-semibold text-sky-200 hover:bg-sky-500/30">
                    <i class="fa-solid fa-plus"></i> Add reward
                  </button>
                  <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-sky-500 to-purple-500 px-6 py-3 text-sm font-semibold shadow-lg shadow-sky-900/40">
                    <i class="fa-solid fa-floppy-disk"></i> Save rewards
                  </button>
                </div>
              </form>
            </div>
          </section>

          <section id="shipments-section" class="hidden space-y-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div>
                <h2 class="text-3xl font-semibold text-white">Fulfillment pipeline</h2>
                <p class="text-slate-400 text-sm max-w-2xl">Track every shipment request from approval to delivery with smart batching.</p>
              </div>
            </div>
            <div id="shipment-board" class="grid gap-6 xl:grid-cols-3">
              <div class="glass-card space-y-4">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-white">Awaiting review</h3>
                  <span class="text-xs uppercase tracking-[0.3em] text-amber-300">Requested</span>
                </div>
                <div id="shipments-requested" class="space-y-4 text-sm"></div>
              </div>
              <div class="glass-card space-y-4">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-white">Approved queue</h3>
                  <span class="text-xs uppercase tracking-[0.3em] text-sky-300">Approved</span>
                </div>
                <div id="shipments-approved" class="space-y-4 text-sm"></div>
              </div>
              <div class="glass-card space-y-4">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-white">Fulfilled orders</h3>
                  <span class="text-xs uppercase tracking-[0.3em] text-emerald-300">Shipped</span>
                </div>
                <div id="shipments-shipped" class="space-y-4 text-sm"></div>
              </div>
            </div>
          </section>

          <section id="support-section" class="hidden space-y-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div>
                <h2 class="text-3xl font-semibold text-white">Support inbox</h2>
                <p class="text-slate-400 text-sm max-w-2xl">Stay close to your community, reply with context, and keep the vibes high.</p>
              </div>
            </div>
            <div id="support-list" class="space-y-6"></div>
          </section>

          <section id="users-section" class="hidden space-y-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div>
                <h2 class="text-3xl font-semibold text-white">User directory</h2>
                <p class="text-slate-400 text-sm max-w-2xl">Search any account by email, username, or UID and update balances or privileges instantly.</p>
              </div>
            </div>
            <div class="glass-card space-y-5">
              <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                <input type="text" id="user-search" class="form-input flex-1" placeholder="Search by email, username, or ID" />
                <button type="button" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 px-5 py-3 text-sm font-semibold" onclick="searchUsers()">
                  <i class="fa-solid fa-magnifying-glass"></i> Search
                </button>
              </div>
              <p class="text-xs text-slate-500">Tip: You can also use the quick search in the top bar to jump straight to results.</p>
              <div id="user-results" class="space-y-6"></div>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <script>
    const db = firebase.database();
    const caseList = document.getElementById('case-list');
    const vaultList = document.getElementById('vault-list');
    const caseForm = document.getElementById('case-form');
    const cancelEditBtn = document.getElementById('cancel-edit');
    const prizesSection = document.getElementById('prizes-section');
    const toast = document.getElementById('toast');
    const imagePreview = document.getElementById('image-preview');
    const imagePlaceholder = document.getElementById('image-placeholder');
    const vaultCheck = document.getElementById('case-vault');
    const cardBackInput = document.getElementById('case-card-back');
    const cardBackWrapper = document.getElementById('card-back-wrapper');
    const caseSearchInput = document.getElementById('case-search');
    const caseHighlights = document.getElementById('overview-case-highlights');
    const recentSupport = document.getElementById('recent-support');
    const marketplaceFormTitle = document.getElementById('marketplace-form-title');
    const logoutButton = document.getElementById('logout-button');
    const globalSearchInput = document.getElementById('global-user-search');
    const homeSpinnerForm = document.getElementById('home-spinner-form');
    const homeSpinnerSelect = document.getElementById('home-spinner-pack');
    const homeSpinnerImage = document.getElementById('home-spinner-image');
    const homeSpinnerTitle = document.getElementById('home-spinner-title');
    const homeSpinnerSubtitle = document.getElementById('home-spinner-subtitle');
    const statElements = {
      totalCases: document.getElementById('stat-total-cases'),
      pickemCases: document.getElementById('stat-pickem-cases'),
      shipmentsPending: document.getElementById('stat-shipments-pending'),
      supportOpen: document.getElementById('stat-support-open'),
      marketplaceItems: document.getElementById('stat-market-items'),
      totalUsers: document.getElementById('stat-total-users')
    };
    const syncLabels = {
      cases: document.getElementById('sync-cases'),
      shipments: document.getElementById('sync-shipments'),
      support: document.getElementById('sync-support'),
      marketplace: document.getElementById('sync-marketplace')
    };
    const shipmentColumns = {
      Requested: document.getElementById('shipments-requested'),
      Approved: document.getElementById('shipments-approved'),
      Shipped: document.getElementById('shipments-shipped')
    };

    const sectionIds = ['overview', 'cases', 'shipments', 'support', 'users', 'marketplace', 'quests', 'rewards'];

    let casesData = [];
    let vaultsData = [];
    let homeSpinnerConfig = {};

    const basePrizeMarkup = `
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
        <h3 class="text-sm font-semibold uppercase tracking-[0.35em] text-slate-300">Prize pools</h3>
        <span class="text-xs text-slate-500">Odds should total 100%</span>
      </div>
      <button type="button" onclick="addPrize()" class="add-prize-btn inline-flex items-center gap-2 rounded-xl bg-emerald-500/20 px-4 py-2 text-sm font-semibold text-emerald-200 hover:bg-emerald-500/30">
        <i class="fa-solid fa-plus"></i> Add prize
      </button>
    `;

    function resetPrizesSection() {
      prizesSection.innerHTML = basePrizeMarkup;
    }

    resetPrizesSection();

    function showToast(message) {
      toast.textContent = message;
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3200);
    }

    function getCaseImage(data) {
      const name = data.name || data.caseName || 'Case';
      if (data.image) return data.image;
      if (data.thumbnail) return data.thumbnail;
      return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=1e293b&color=f8fafc&rounded=true`;
    }

    function updateHomeSpinnerPreview(data) {
      if (!homeSpinnerImage || !homeSpinnerTitle || !homeSpinnerSubtitle) return;
      if (!data) {
        homeSpinnerImage.classList.add('hidden');
        homeSpinnerTitle.textContent = 'No pack selected';
        homeSpinnerSubtitle.textContent = 'Choose a pack to update the homepage spinner.';
        return;
      }
      const normalized = { ...data };
      normalized.name = normalized.name || normalized.caseName || 'Featured pack';
      if (!normalized.image && normalized.thumbnail) normalized.image = normalized.thumbnail;
      const imageUrl = getCaseImage(normalized);
      let priceLabel = 'Featured on homepage';
      if (normalized.isFree) {
        priceLabel = 'Free pack';
      } else if (normalized.price !== undefined && normalized.price !== null) {
        const numeric = Number(normalized.price);
        if (!Number.isNaN(numeric) && numeric > 0) {
          priceLabel = `${numeric.toLocaleString()} gems`;
        }
      }
      homeSpinnerImage.src = imageUrl;
      homeSpinnerImage.alt = `${normalized.name} preview`;
      homeSpinnerImage.classList.remove('hidden');
      homeSpinnerTitle.textContent = normalized.name;
      homeSpinnerSubtitle.textContent = priceLabel;
    }

    function updateHomeSpinnerPreviewFromConfig() {
      if (!homeSpinnerConfig.caseId) {
        updateHomeSpinnerPreview(null);
        return;
      }
      const selected = casesData.find(item => item.key === homeSpinnerConfig.caseId);
      if (selected) {
        updateHomeSpinnerPreview(selected);
      } else {
        updateHomeSpinnerPreview(homeSpinnerConfig);
      }
    }

    function populateHomeSpinnerSelect() {
      if (!homeSpinnerSelect) return;
      const savedId = homeSpinnerConfig.caseId || '';
      homeSpinnerSelect.innerHTML = '<option value="">Select a pack‚Ä¶</option>';
      casesData.forEach(item => {
        const option = document.createElement('option');
        option.value = item.key;
        option.textContent = item.name || 'Untitled drop';
        if (item.key === savedId) option.selected = true;
        homeSpinnerSelect.appendChild(option);
      });
      if (!savedId) {
        homeSpinnerSelect.value = '';
      }
      updateHomeSpinnerPreviewFromConfig();
    }

    function loadHomeSpinnerConfig() {
      db.ref('homeSpinnerConfig').on('value', snapshot => {
        homeSpinnerConfig = snapshot.val() || {};
        if (homeSpinnerSelect) {
          const savedId = homeSpinnerConfig.caseId || '';
          if (savedId && Array.from(homeSpinnerSelect.options).some(opt => opt.value === savedId)) {
            homeSpinnerSelect.value = savedId;
          } else if (!savedId) {
            homeSpinnerSelect.value = '';
          }
        }
        updateHomeSpinnerPreviewFromConfig();
      });
    }

    function updateSyncStamp(key) {
      if (syncLabels[key]) {
        syncLabels[key].textContent = new Date().toLocaleTimeString();
      }
    }

    function setStat(key, value) {
      if (statElements[key]) {
        statElements[key].textContent = value;
      }
    }

    function showSection(id) {
      sectionIds.forEach(section => {
        const el = document.getElementById(section + '-section');
        if (el) el.classList.toggle('hidden', section !== id);
      });
      document.querySelectorAll('.admin-nav-link').forEach(btn => {
        if (btn.dataset.section === id) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    document.querySelectorAll('[data-section]').forEach(button => {
      button.addEventListener('click', event => {
        event.preventDefault();
        const target = button.dataset.section;
        if (target) showSection(target);
      });
    });

    if (logoutButton) {
      logoutButton.addEventListener('click', () => {
        firebase.auth().signOut();
      });
    }

    if (globalSearchInput) {
      globalSearchInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const query = globalSearchInput.value.trim();
          if (!query) return;
          showSection('users');
          const userSearch = document.getElementById('user-search');
          if (userSearch) {
            userSearch.value = query;
            searchUsers();
            globalSearchInput.blur();
          }
        }
      });
    }

    function previewImage(url) {
      if (url) {
        imagePreview.src = url;
        imagePreview.classList.remove('hidden');
        imagePlaceholder?.classList.add('hidden');
      } else {
        imagePreview.classList.add('hidden');
        imagePlaceholder?.classList.remove('hidden');
      }
    }

    vaultCheck.addEventListener('change', () => {
      cardBackWrapper.classList.toggle('hidden', !vaultCheck.checked);
    });

    if (caseSearchInput) {
      caseSearchInput.addEventListener('input', () => renderCaseCollections());
    }

    function addPrize(prize = {}) {
      const div = document.createElement('div');
      div.className = 'prize-block border border-slate-800/70 bg-slate-900/60 rounded-xl p-4 space-y-3 shadow-sm shadow-slate-900/40';
      div.innerHTML = `
        <div class="flex flex-wrap items-center justify-between gap-2">
          <span class="text-sm font-semibold text-slate-100">${prize.name ? prize.name : 'New prize'}</span>
          <button type="button" class="remove-prize text-xs uppercase tracking-[0.3em] text-rose-300 hover:text-rose-200 inline-flex items-center gap-1">
            <i class="fa-solid fa-xmark"></i> Remove
          </button>
        </div>
        <div class="grid gap-3 md:grid-cols-2">
          <div class="space-y-1">
            <span class="text-xs uppercase tracking-wide text-slate-400">Prize name</span>
            <input type="text" value="${prize.name || ''}" class="prize-name form-input" placeholder="Premium pull" />
          </div>
          <div class="space-y-1">
            <span class="text-xs uppercase tracking-wide text-slate-400">Image URL</span>
            <input type="text" value="${prize.image || ''}" class="prize-image form-input" placeholder="https://‚Ä¶" />
          </div>
          <div class="space-y-1">
            <span class="text-xs uppercase tracking-wide text-slate-400">Rarity</span>
            <select class="prize-rarity form-select">
              <option value="common" ${prize.rarity === 'common' ? 'selected' : ''}>Common</option>
              <option value="uncommon" ${prize.rarity === 'uncommon' ? 'selected' : ''}>Uncommon</option>
              <option value="rare" ${prize.rarity === 'rare' ? 'selected' : ''}>Rare</option>
              <option value="ultra rare" ${prize.rarity === 'ultra rare' ? 'selected' : ''}>Ultra Rare</option>
              <option value="legendary" ${prize.rarity === 'legendary' ? 'selected' : ''}>Legendary</option>
            </select>
          </div>
          <div class="space-y-1">
            <span class="text-xs uppercase tracking-wide text-slate-400">Value ($)</span>
            <input type="number" step="0.01" min="0" value="${prize.value || ''}" class="prize-value form-input" placeholder="49.99" />
          </div>
          <div class="space-y-1">
            <span class="text-xs uppercase tracking-wide text-slate-400">Odds (%)</span>
            <input type="number" step="any" min="0" value="${prize.odds || ''}" class="prize-odds form-input" placeholder="12.5" />
          </div>
        </div>
      `;
      const removeBtn = div.querySelector('.remove-prize');
      removeBtn?.addEventListener('click', () => div.remove());
      const addButton = prizesSection.querySelector('.add-prize-btn');
      if (addButton) {
        addButton.insertAdjacentElement('afterend', div);
      } else {
        prizesSection.appendChild(div);
      }
    }

    function formatPrice(data) {
      if (data.isFree) return 'Free case';
      const value = Number(data.price || 0);
      return `$${value.toFixed(2)}`;
    }

    function badge(label, classes) {
      return `<span class="inline-flex items-center rounded-full px-2.5 py-1 text-[0.65rem] font-semibold uppercase tracking-wide ${classes}">${label}</span>`;
    }

    function renderCaseList(container, list, filter, isVault) {
      if (!container) return;
      container.innerHTML = '';
      const query = filter ? filter.toLowerCase() : '';
      const filtered = query ? list.filter(item => (item.name || '').toLowerCase().includes(query)) : list;
      if (!filtered.length) {
        container.innerHTML = `<p class="text-sm text-slate-500">${query ? 'No matches found.' : 'No cases available yet.'}</p>`;
        return;
      }
      filtered.forEach(item => {
        const div = document.createElement('article');
        div.className = 'glass-subcard flex flex-col sm:flex-row gap-4 items-start sm:items-center';
        const price = formatPrice(item);
        const categories = [];
        if (item.categories?.new) categories.push(badge('New', 'bg-purple-500/10 text-purple-200 border border-purple-500/30'));
        if (item.categories?.featured) categories.push(badge('Featured', 'bg-amber-500/10 text-amber-200 border border-amber-500/30'));
        if (item.categories?.starter) categories.push(badge('Starter', 'bg-sky-500/10 text-sky-200 border border-sky-500/30'));
        const spice = item.spiceLevel ? badge(item.spiceLevel, 'bg-rose-500/15 text-rose-200 border border-rose-500/30 capitalize') : '';
        const image = getCaseImage(item);
        div.innerHTML = `
          <img src="${image}" alt="${item.name || 'Case'}" class="h-16 w-16 rounded-xl object-cover border border-slate-800/70 shadow-lg shadow-slate-900/40" />
          <div class="flex-1 space-y-2">
            <div class="flex flex-wrap items-center gap-2">
              <p class="text-base font-semibold text-white">${item.name || 'Untitled drop'}</p>
              ${item.tag ? badge(item.tag, 'bg-slate-800/70 text-slate-200 border border-slate-700/70 normal-case') : ''}
              ${spice}
            </div>
            <p class="text-sm text-slate-400">${price}${isVault ? ' ¬∑ Pick\'em mode' : ''}</p>
            <div class="flex flex-wrap gap-2">${categories.join('')}</div>
          </div>
          <div class="flex flex-col sm:flex-row gap-2">
            <button type="button" onclick="editCase('${item.key}', ${isVault})" class="inline-flex items-center justify-center gap-2 rounded-xl border border-slate-700/80 px-4 py-2 text-xs font-semibold hover:bg-slate-800/60">
              <i class="fa-solid fa-pen"></i> Edit
            </button>
            <button type="button" onclick="deleteCase('${item.key}', ${isVault})" class="inline-flex items-center justify-center gap-2 rounded-xl bg-rose-500/20 px-4 py-2 text-xs font-semibold text-rose-200 hover:bg-rose-500/30">
              <i class="fa-solid fa-trash"></i> Delete
            </button>
          </div>
        `;
        container.appendChild(div);
      });
    }
    function updateCaseHighlights() {
      if (!caseHighlights) return;
      const combined = [
        ...casesData.map(item => ({ ...item, isVault: false })),
        ...vaultsData.map(item => ({ ...item, isVault: true }))
      ];
      if (!combined.length) {
        caseHighlights.innerHTML = '<p class="text-sm text-slate-500">Add a case to see highlights.</p>';
        return;
      }
      combined.sort((a, b) => (Number(b.price || 0) || 0) - (Number(a.price || 0) || 0));
      const top = combined.slice(0, 3);
      caseHighlights.innerHTML = top.map(item => `
        <div class="glass-subcard flex items-center justify-between gap-3">
          <div>
            <p class="text-sm font-semibold text-white">${item.name || 'Untitled drop'}</p>
            <p class="text-xs text-slate-400">${item.isVault ? "Pick'em" : 'Standard'} ¬∑ ${formatPrice(item)}</p>
          </div>
          <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-slate-700/80 px-3 py-2 text-xs font-semibold hover:bg-slate-800/70" onclick="showSection('cases'); editCase('${item.key}', ${item.isVault});">
            <i class="fa-solid fa-wand-magic-sparkles"></i> Edit
          </button>
        </div>
      `).join('');
    }

    function renderCaseCollections() {
      const filter = caseSearchInput ? caseSearchInput.value : '';
      renderCaseList(caseList, casesData, filter, false);
      renderCaseList(vaultList, vaultsData, filter, true);
      setStat('totalCases', casesData.length);
      setStat('pickemCases', vaultsData.length);
      updateCaseHighlights();
    }

    function loadCases() {
      db.ref('cases').on('value', snapshot => {
        casesData = [];
        snapshot.forEach(child => {
          casesData.push({ key: child.key, ...(child.val() || {}) });
        });
        renderCaseCollections();
        updateSyncStamp('cases');
        populateHomeSpinnerSelect();
      });

      db.ref('vaults').on('value', snapshot => {
        vaultsData = [];
        snapshot.forEach(child => {
          vaultsData.push({ key: child.key, ...(child.val() || {}) });
        });
        renderCaseCollections();
        updateSyncStamp('cases');
      });
    }

    function renderShipmentCard(id, item) {
      const info = item.shippingInfo || {};
      const status = item.status || 'Requested';
      const card = document.createElement('div');
      card.className = 'glass-subcard space-y-3';
      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <p class="text-sm font-semibold text-white">${item.name || 'Reward'}</p>
            <p class="text-xs text-slate-400">User: ${item.userId || 'Unknown'}</p>
          </div>
          <span class="text-xs uppercase tracking-[0.35em] ${status === 'Shipped' ? 'text-emerald-300' : status === 'Approved' ? 'text-sky-300' : 'text-amber-300'}">${status}</span>
        </div>
        <div class="space-y-1 text-xs text-slate-400">
          <p><strong class="text-slate-300">Name:</strong> ${info.name || '-'}</p>
          <p><strong class="text-slate-300">Address:</strong> ${info.address || '-'}</p>
          <p><strong class="text-slate-300">City:</strong> ${info.city || '-'}</p>
          <p><strong class="text-slate-300">Zip:</strong> ${info.zip || '-'}</p>
          <p><strong class="text-slate-300">Phone:</strong> ${info.phone || '-'}</p>
        </div>
        <div class="flex flex-wrap gap-2 pt-2">
          ${status === 'Requested' ? `<button type="button" class="inline-flex items-center gap-2 rounded-xl bg-sky-500/20 px-3 py-2 text-xs font-semibold text-sky-200 hover:bg-sky-500/30" onclick="approveShipment('${id}')"><i class="fa-solid fa-circle-check"></i>Approve</button>` : ''}
          ${status !== 'Shipped' ? `<button type="button" class="inline-flex items-center gap-2 rounded-xl bg-emerald-500/20 px-3 py-2 text-xs font-semibold text-emerald-200 hover:bg-emerald-500/30" onclick="markShipped('${id}')"><i class="fa-solid fa-truck"></i>Mark shipped</button>` : ''}
          <button type="button" class="inline-flex items-center gap-2 rounded-xl bg-rose-500/20 px-3 py-2 text-xs font-semibold text-rose-200 hover:bg-rose-500/30" onclick="deleteShipment('${id}')"><i class="fa-solid fa-trash"></i>Delete</button>
        </div>
      `;
      return card;
    }

    function loadShipments() {
      db.ref('shipments').on('value', snapshot => {
        Object.values(shipmentColumns).forEach(col => { if (col) col.innerHTML = ''; });
        let pendingCount = 0;
        snapshot.forEach(child => {
          const item = child.val() || {};
          const status = item.status || 'Requested';
          if (status !== 'Shipped') pendingCount += 1;
          const column = shipmentColumns[status] || shipmentColumns.Requested;
          column?.appendChild(renderShipmentCard(child.key, item));
        });
        setStat('shipmentsPending', pendingCount);
        updateSyncStamp('shipments');
        Object.entries(shipmentColumns).forEach(([status, column]) => {
          if (column && !column.children.length) {
            column.innerHTML = '<p class="text-sm text-slate-500">No shipments in this stage.</p>';
          }
        });
      });
    }

    function renderSupportMessages(messages = []) {
      if (!messages.length) {
        return '<p class="text-xs text-slate-500">No messages yet.</p>';
      }
      return messages.map(msg => {
        const time = msg.timestamp ? new Date(msg.timestamp).toLocaleString() : '';
        const alignment = msg.sender === 'admin' ? 'items-end text-emerald-200' : 'items-start text-slate-200';
        const bubble = msg.sender === 'admin' ? 'bg-emerald-500/20 text-emerald-100' : 'bg-slate-800/80 text-slate-100';
        return `
          <div class="flex ${alignment}">
            <div class="max-w-full rounded-xl ${bubble} px-3 py-2 text-xs">
              <p class="font-semibold text-[0.7rem] uppercase tracking-[0.3em] mb-1">${msg.sender}</p>
              <p class="text-sm leading-relaxed">${msg.text}</p>
              <p class="mt-1 text-[0.65rem] text-slate-400">${time}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    function loadSupportForms() {
      const container = document.getElementById('support-list');
      firebase.database().ref('supportCases').on('value', snapshot => {
        container.innerHTML = '';
        const supportArray = [];
        snapshot.forEach(child => {
          const data = child.val() || {};
          const messages = Object.values(data.messages || {});
          const latestTimestamp = messages.length ? Math.max(...messages.map(m => m.timestamp || 0)) : 0;
          supportArray.push({ key: child.key, data, messages, latestTimestamp });
        });
        supportArray.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
        const openCases = supportArray.filter(item => (item.data.status || '').toLowerCase() !== 'resolved');
        setStat('supportOpen', openCases.length);
        updateSyncStamp('support');

        if (!supportArray.length) {
          container.innerHTML = '<p class="text-sm text-slate-500">No support messages at the moment.</p>';
        }

        supportArray.forEach(({ key, data, messages }) => {
          const status = data.status || 'Open';
          const statusClass = status === 'Resolved' ? 'text-emerald-300' : status === 'Pending' ? 'text-amber-300' : 'text-sky-300';
          const div = document.createElement('div');
          div.className = 'glass-card space-y-4';
          div.innerHTML = `
            <div class="flex flex-wrap items-start justify-between gap-3">
              <div>
                <p class="text-base font-semibold text-white">${data.subject || 'Support case'}</p>
                <p class="text-sm text-slate-400">${data.email || 'No email provided'}</p>
              </div>
              <span class="text-xs uppercase tracking-[0.35em] ${statusClass}">${status}</span>
            </div>
            <div class="space-y-2 rounded-2xl border border-slate-800/70 bg-slate-950/50 p-3 max-h-64 overflow-y-auto">
              ${renderSupportMessages(messages)}
            </div>
            <form onsubmit="adminReply(event, '${key}')" class="space-y-2">
              <textarea class="form-textarea admin-reply" placeholder="Craft a thoughtful reply‚Ä¶"></textarea>
              <div class="flex justify-end">
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-emerald-500 to-sky-500 px-5 py-2 text-sm font-semibold">
                  <i class="fa-solid fa-paper-plane"></i> Send reply
                </button>
              </div>
            </form>
          `;
          container.appendChild(div);
        });

        if (recentSupport) {
          if (!supportArray.length) {
            recentSupport.innerHTML = '<p class="text-sm text-slate-500">Support inbox is clear ‚Äì nice work!</p>';
          } else {
            recentSupport.innerHTML = supportArray.slice(0, 3).map(({ key, data }) => {
              return `
                <div class="glass-subcard space-y-1">
                  <div class="flex items-center justify-between">
                    <p class="text-sm font-semibold text-white">${data.subject || 'Support case'}</p>
                    <span class="text-[0.6rem] uppercase tracking-[0.3em] text-slate-500">${data.status || 'Open'}</span>
                  </div>
                  <p class="text-xs text-slate-400">${data.email || 'No email'}</p>
                  <button type="button" class="inline-flex items-center gap-1 rounded-xl border border-slate-700/80 px-3 py-1 text-xs font-semibold hover:bg-slate-800/70" onclick="showSection('support'); document.getElementById('support-list').scrollIntoView({ behavior: 'smooth' });">
                    <i class="fa-solid fa-arrow-right"></i> Open thread
                  </button>
                </div>
              `;
            }).join('');
          }
        }
      });
    }
    function adminReply(event, caseId) {
      event.preventDefault();
      const form = event.target;
      const textarea = form.querySelector('.admin-reply');
      const reply = textarea.value.trim();
      if (!reply) return;

      const newReplyKey = firebase.database().ref().push().key;
      const updates = {};
      updates[`supportCases/${caseId}/messages/${newReplyKey}`] = {
        sender: 'admin',
        text: reply,
        timestamp: Date.now()
      };
      updates[`supportCases/${caseId}/status`] = 'Replied';

      firebase.database().ref().update(updates).then(() => {
        textarea.value = '';
        showToast('‚úÖ Reply sent');
      });
    }

    function editCase(id, isVault = false) {
      const path = (isVault ? 'vaults/' : 'cases/') + id;
      db.ref(path).once('value').then(snapshot => {
        const data = snapshot.val();
        document.getElementById('form-title').innerText = 'Edit case';
        document.getElementById('case-id').value = id;
        document.getElementById('case-path').value = isVault ? 'vaults' : 'cases';
        document.getElementById('case-name').value = data.name || '';
        document.getElementById('case-image').value = data.image || '';
        previewImage(data.image);
        document.getElementById('case-price').value = data.price || 0;
        document.getElementById('case-free').checked = !!data.isFree;
        document.getElementById('case-tag').value = data.tag || '';
        document.getElementById('case-new').checked = !!(data.categories && data.categories.new);
        document.getElementById('case-featured').checked = !!(data.categories && data.categories.featured);
        document.getElementById('case-starter').checked = !!(data.categories && data.categories.starter);
        document.getElementById('case-spice').value = data.spiceLevel || '';
        document.getElementById('case-vault').checked = !!data.vault;
        document.getElementById('case-card-back').value = data.cardBack || '';
        cardBackWrapper.classList.toggle('hidden', !data.vault);
        resetPrizesSection();
        if (data.prizes) Object.values(data.prizes).forEach(p => addPrize(p));
        cancelEditBtn.classList.remove('hidden');
      });
    }

    function deleteCase(id, isVault = false) {
      if (confirm('Are you sure you want to delete this case?')) {
        const path = isVault ? 'vaults/' : 'cases/';
        db.ref(path + id).remove().then(() => showToast('‚ùå Case deleted'));
      }
    }

    function markShipped(id) {
      db.ref('shipments/' + id).update({ status: 'Shipped' }).then(() => showToast('üì¶ Marked as shipped'));
    }

    function approveShipment(id) {
      db.ref('shipments/' + id).update({ status: 'Approved' }).then(() => showToast('‚úÖ Shipment approved'));
    }

    function deleteShipment(id) {
      if (confirm('Are you sure you want to delete this shipment?')) {
        db.ref('shipments/' + id).remove().then(() => {
          showToast('üóëÔ∏è Shipment deleted');
        });
      }
    }

    function saveCase(e) {
      e.preventDefault();
      const idField = document.getElementById('case-id');
      const pathField = document.getElementById('case-path');
      const vault = vaultCheck.checked;
      const path = vault ? 'vaults' : 'cases';
      const id = idField.value || db.ref(path).push().key;
      const name = document.getElementById('case-name').value;
      const image = document.getElementById('case-image').value;
      const isFree = document.getElementById('case-free').checked;
      const price = isFree ? 0 : parseFloat(document.getElementById('case-price').value) || 0;
      const tag = document.getElementById('case-tag').value.trim();
      const spiceLevel = document.getElementById('case-spice').value.trim();
      const cardBack = cardBackInput.value.trim();
      const categories = {
        new: document.getElementById('case-new').checked,
        featured: document.getElementById('case-featured').checked,
        starter: document.getElementById('case-starter').checked
      };
      const prizesElements = prizesSection.querySelectorAll('div.prize-block');
      const prizes = {};
      prizesElements.forEach((div, idx) => {
        prizes[idx] = {
          name: div.querySelector('.prize-name').value,
          image: div.querySelector('.prize-image').value,
          rarity: div.querySelector('.prize-rarity').value,
          value: parseFloat(div.querySelector('.prize-value').value) || 0,
          odds: parseFloat(div.querySelector('.prize-odds').value) || 0
        };
      });

      const data = { name, image, price, tag, spiceLevel, isFree, vault, cardBack, prizes, categories };
      const updates = {};
      updates[`${path}/${id}`] = data;
      const originalPath = pathField.value;
      if (originalPath && originalPath !== path) {
        updates[`${originalPath}/${id}`] = null;
      }

      db.ref().update(updates).then(() => {
        caseForm.reset();
        previewImage('');
        resetPrizesSection();
        vaultCheck.checked = false;
        cardBackInput.value = '';
        cardBackWrapper.classList.add('hidden');
        document.getElementById('form-title').innerText = 'Add a new case';
        cancelEditBtn.classList.add('hidden');
        idField.value = '';
        pathField.value = '';
        showToast('‚úÖ Case saved successfully!');
      });
    }

    function cancelEdit() {
      caseForm.reset();
      previewImage('');
      resetPrizesSection();
      vaultCheck.checked = false;
      cardBackInput.value = '';
      cardBackWrapper.classList.add('hidden');
      document.getElementById('form-title').innerText = 'Add a new case';
      cancelEditBtn.classList.add('hidden');
      document.getElementById('case-id').value = '';
      document.getElementById('case-path').value = '';
    }

    caseForm.addEventListener('submit', saveCase);
    cancelEditBtn.addEventListener('click', cancelEdit);

    document.getElementById('user-search').addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchUsers();
      }
    });

    function searchUsers() {
      const query = document.getElementById('user-search').value.trim().toLowerCase();
      if (!query) return;

      const resultsDiv = document.getElementById('user-results');
      resultsDiv.innerHTML = 'Searching...';

      firebase.database().ref('users').once('value').then(snapshot => {
        let found = false;
        resultsDiv.innerHTML = '';

        snapshot.forEach(child => {
          const user = child.val() || {};
          const email = (user.email || '').toLowerCase();
          const username = (user.username || '').toLowerCase();
          const uid = child.key.toLowerCase();

          if (
            email === query ||
            username === query ||
            uid === query ||
            email.includes(query) ||
            username.includes(query) ||
            uid.includes(query)
          ) {
            found = true;
            const div = document.createElement('div');
            div.className = 'glass-card space-y-4';
            div.innerHTML = `
              <div class="flex flex-wrap items-center justify-between gap-2">
                <h3 class="text-lg font-semibold text-white">${user.username || user.email || 'User'} <span class="text-xs text-slate-400">(${child.key})</span></h3>
                <div class="flex flex-wrap gap-2">
                  <button onclick="saveUser('${child.key}')" class="inline-flex items-center gap-2 rounded-xl bg-emerald-500/20 px-3 py-2 text-xs font-semibold text-emerald-200 hover:bg-emerald-500/30"><i class="fa-solid fa-floppy-disk"></i>Save</button>
                  <button onclick="sendPasswordReset('${user.email || ''}')" class="inline-flex items-center gap-2 rounded-xl bg-sky-500/20 px-3 py-2 text-xs font-semibold text-sky-200 hover:bg-sky-500/30"><i class="fa-solid fa-key"></i>Reset password</button>
                  <button onclick="deleteUser('${child.key}')" class="inline-flex items-center gap-2 rounded-xl bg-rose-500/20 px-3 py-2 text-xs font-semibold text-rose-200 hover:bg-rose-500/30"><i class="fa-solid fa-trash"></i>Delete</button>
                </div>
              </div>
              <div class="grid gap-4 md:grid-cols-2">
                <label class="space-y-1 text-sm text-slate-300">Name<input type="text" id="name-${child.key}" value="${user.name || ''}" class="form-input"></label>
                <label class="space-y-1 text-sm text-slate-300">Username<input type="text" id="username-${child.key}" value="${user.username || ''}" class="form-input"></label>
                <label class="space-y-1 text-sm text-slate-300">Email<input type="text" id="email-${child.key}" value="${user.email || ''}" class="form-input"></label>
                <label class="space-y-1 text-sm text-slate-300">Email verified
                  <select id="verified-${child.key}" class="form-select">
                    <option value="false" ${!user.emailVerified ? 'selected' : ''}>No</option>
                    <option value="true" ${user.emailVerified ? 'selected' : ''}>Yes</option>
                  </select>
                </label>
                <label class="space-y-1 text-sm text-slate-300">Phone<input type="text" id="phone-${child.key}" value="${user.phone || ''}" class="form-input"></label>
                <label class="space-y-1 text-sm text-slate-300">Balance<input type="number" step="any" id="balance-${child.key}" value="${user.balance || 0}" class="form-input"></label>
                <label class="space-y-1 text-sm text-slate-300">Role
                  <select id="role-${child.key}" class="form-select">
                    <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                  </select>
                </label>
                <label class="space-y-1 text-sm text-slate-300">Free case opened
                  <select id="free-${child.key}" class="form-select">
                    <option value="false" ${!user.freeCaseOpened ? 'selected' : ''}>No</option>
                    <option value="true" ${user.freeCaseOpened ? 'selected' : ''}>Yes</option>
                  </select>
                </label>
              </div>
              <div class="space-y-2">
                <button onclick="loadHistory('${child.key}', this)" class="inline-flex items-center gap-2 rounded-xl bg-sky-500/20 px-3 py-2 text-xs font-semibold text-sky-200 hover:bg-sky-500/30">Load history</button>
                <div class="overflow-x-auto border border-slate-800/70 rounded-xl">
                  <table class="min-w-full text-xs text-slate-300">
                    <thead>
                      <tr>
                        <th class="px-3 py-2 text-left">Item</th>
                        <th class="px-3 py-2 text-left">Rarity</th>
                        <th class="px-3 py-2 text-left">Value</th>
                        <th class="px-3 py-2 text-left">Status</th>
                        <th class="px-3 py-2 text-left">Unbox Balance</th>
                        <th class="px-3 py-2 text-left">Sale Balance</th>
                        <th class="px-3 py-2 text-left">Timestamp</th>
                      </tr>
                    </thead>
                    <tbody id="unbox-${child.key}"><tr><td colspan="7" class="px-3 py-2">History not loaded.</td></tr></tbody>
                  </table>
                </div>
              </div>
            `;
            resultsDiv.appendChild(div);
          }
        });

        if (!found) resultsDiv.innerHTML = 'No users found.';
      });
    }
    function loadHistory(uid, btn) {
      const unboxList = document.getElementById(`unbox-${uid}`);
      if (!unboxList) return;
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Loading...';
      }
      Promise.all([
        firebase.database().ref(`users/${uid}/unboxHistory`).once('value'),
        firebase.database().ref(`users/${uid}/inventory`).once('value')
      ]).then(([histSnap, invSnap]) => {
        const itemMap = new Map();
        if (histSnap.exists()) {
          histSnap.forEach(item => {
            itemMap.set(item.key, item.val());
          });
        }
        if (invSnap.exists()) {
          invSnap.forEach(item => {
            if (!itemMap.has(item.key)) itemMap.set(item.key, item.val());
          });
        }
        const items = Array.from(itemMap.values());
        if (items.length) {
          unboxList.innerHTML = '';
          items
            .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
            .forEach(winData => {
              const date = winData.timestamp ? new Date(winData.timestamp).toLocaleString() : '';
              const status = winData.sold ? 'Sold' : 'Owned';
              const unboxBal = `${winData.balanceBefore ?? '-'}‚Üí${winData.balanceAfter ?? '-'}`;
              const saleBal = winData.sold ? `${winData.saleBalanceBefore ?? '-'}‚Üí${winData.saleBalanceAfter ?? '-'}` : '-';
              unboxList.innerHTML += `<tr>
                  <td class="px-3 py-2">${winData.name}</td>
                  <td class="px-3 py-2">${winData.rarity || ''}</td>
                  <td class="px-3 py-2">$${winData.value || 0}</td>
                  <td class="px-3 py-2">${status}</td>
                  <td class="px-3 py-2">${unboxBal}</td>
                  <td class="px-3 py-2">${saleBal}</td>
                  <td class="px-3 py-2 text-xs">${date}</td>
                </tr>`;
            });
        } else {
          unboxList.innerHTML = '<tr><td colspan="7" class="px-3 py-2">No history found.</td></tr>';
        }
      }).finally(() => {
        if (btn) btn.remove();
      });
    }

    function saveUser(uid) {
      const updates = {
        name: document.getElementById(`name-${uid}`).value.trim(),
        username: document.getElementById(`username-${uid}`).value.trim(),
        email: document.getElementById(`email-${uid}`).value.trim(),
        emailVerified: document.getElementById(`verified-${uid}`).value === 'true',
        phone: document.getElementById(`phone-${uid}`).value.trim(),
        balance: parseFloat(document.getElementById(`balance-${uid}`).value) || 0,
        role: document.getElementById(`role-${uid}`).value,
        freeCaseOpened: document.getElementById(`free-${uid}`).value === 'true'
      };

      firebase.database().ref(`users/${uid}`).update(updates).then(() => {
        showToast('‚úÖ User updated');
      });
    }

    function deleteUser(uid) {
      if (!confirm('Are you sure you want to delete this user?')) return;
      firebase.database().ref(`users/${uid}`).remove().then(() => {
        showToast('üóëÔ∏è User deleted');
        searchUsers();
      });
    }

    function sendPasswordReset(email) {
      if (!email) {
        alert('User has no email to reset.');
        return;
      }
      firebase.auth().sendPasswordResetEmail(email).then(() => {
        showToast('‚úÖ Reset email sent');
      }).catch(err => alert(err.message));
    }

    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        alert('Please log in.');
        window.location.href = '/auth.html';
        return;
      }

      if (!allowedAdmins.includes(user.email)) {
        alert('Access denied. Admins only.');
        window.location.href = '/';
        return;
      }

      document.getElementById('admin-panel').style.display = 'block';
      showSection('overview');
      loadHomeSpinnerConfig();
      loadCases();
      loadShipments();
      loadSupportForms();
      loadMarketplaceItems();
      loadQuestConfig();
      loadWheelRewards();
      loadUserCount();
    });

    homeSpinnerSelect?.addEventListener('change', () => {
      if (!homeSpinnerSelect.value) {
        updateHomeSpinnerPreview(null);
        return;
      }
      const selected = casesData.find(item => item.key === homeSpinnerSelect.value);
      if (selected) {
        updateHomeSpinnerPreview(selected);
      }
    });

    homeSpinnerForm?.addEventListener('submit', event => {
      event.preventDefault();
      if (!homeSpinnerSelect) return;
      const caseId = homeSpinnerSelect.value;
      if (!caseId) {
        db.ref('homeSpinnerConfig').remove().then(() => {
          homeSpinnerConfig = {};
          updateHomeSpinnerPreview(null);
          showToast('‚úÖ Homepage spinner reset');
        }).catch(() => showToast('‚ö†Ô∏è Failed to reset spinner'));
        return;
      }
      const selected = casesData.find(item => item.key === caseId);
      if (!selected) {
        showToast('‚ö†Ô∏è Could not find that pack');
        return;
      }
      const payload = {
        caseId,
        caseName: selected.name || 'Featured pack',
        thumbnail: getCaseImage(selected),
        price: Number(selected.price || 0),
        isFree: !!selected.isFree,
        updatedAt: Date.now()
      };
      db.ref('homeSpinnerConfig').set(payload).then(() => {
        homeSpinnerConfig = payload;
        updateHomeSpinnerPreview(selected);
        showToast('‚úÖ Homepage spinner updated');
      }).catch(() => showToast('‚ö†Ô∏è Failed to update spinner'));
    });

    document.getElementById('marketplace-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('market-name').value.trim();
      const image = document.getElementById('market-image').value.trim();
      const value = parseInt(document.getElementById('market-value').value.trim(), 10);
      const rarity = document.getElementById('market-rarity').value;

      if (!name || !image || !value || !rarity) return alert('All fields are required!');

      const form = document.getElementById('marketplace-form');
      const submitButton = form.querySelector("button[type='submit']");
      const editingKey = form.dataset.editing;
      let message = '';

      if (editingKey) {
        await firebase.database().ref('marketplace/' + editingKey).set({ name, image, value, rarity, timestamp: Date.now() });
        message = '‚úÖ Product updated!';
        form.dataset.editing = '';
        submitButton.textContent = 'Add product';
        marketplaceFormTitle.textContent = 'Add marketplace product';
      } else {
        const newRef = firebase.database().ref('marketplace').push();
        await newRef.set({ name, image, value, rarity, timestamp: Date.now() });
        message = '‚úÖ Card added to marketplace!';
      }

      form.reset();
      showToast(message);
    });

    function buildMarketplaceCard(item, key) {
      const card = document.createElement('div');
      card.className = 'glass-subcard flex flex-col sm:flex-row gap-4 items-start sm:items-center';
      const image = item.image || `https://ui-avatars.com/api/?name=${encodeURIComponent(item.name || 'Card')}&background=1e293b&color=f8fafc&rounded=true`;
      card.innerHTML = `
        <img src="${image}" alt="${item.name || 'Marketplace item'}" class="h-16 w-16 rounded-xl object-cover border border-slate-800/70 shadow-lg shadow-slate-900/40" />
        <div class="flex-1 space-y-1">
          <p class="text-base font-semibold text-white">${item.name || 'Untitled'}</p>
          <p class="text-sm text-slate-400">${item.value} gems ¬∑ ${item.rarity}</p>
          <p class="text-xs text-slate-500">Listed ${item.timestamp ? new Date(item.timestamp).toLocaleString() : 'recently'}</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-2">
          <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-slate-700/80 px-4 py-2 text-xs font-semibold hover:bg-slate-800/60" data-edit="${key}">
            <i class="fa-solid fa-pen"></i> Edit
          </button>
          <button type="button" class="inline-flex items-center gap-2 rounded-xl bg-rose-500/20 px-4 py-2 text-xs font-semibold text-rose-200 hover:bg-rose-500/30" data-delete="${key}">
            <i class="fa-solid fa-trash"></i> Delete
          </button>
        </div>
      `;
      const editBtn = card.querySelector('[data-edit]');
      const deleteBtn = card.querySelector('[data-delete]');
      editBtn.addEventListener('click', () => editMarketplaceItem(key, item));
      deleteBtn.addEventListener('click', () => deleteMarketplaceItem(key));
      return card;
    }

    function loadMarketplaceItems() {
      const container = document.getElementById('market-list');
      firebase.database().ref('marketplace').on('value', snapshot => {
        container.innerHTML = '';
        const items = [];
        snapshot.forEach(child => {
          items.push({ key: child.key, ...(child.val() || {}) });
        });
        items.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        setStat('marketplaceItems', items.length);
        updateSyncStamp('marketplace');
        if (!items.length) {
          container.innerHTML = '<p class="text-sm text-slate-500">No items in the marketplace yet.</p>';
          return;
        }
        items.forEach(item => {
          container.appendChild(buildMarketplaceCard(item, item.key));
        });
      });
    }
    function editMarketplaceItem(key, item) {
      document.getElementById('market-name').value = item.name;
      document.getElementById('market-image').value = item.image;
      document.getElementById('market-value').value = item.value;
      document.getElementById('market-rarity').value = item.rarity;
      const form = document.getElementById('marketplace-form');
      form.dataset.editing = key;
      form.querySelector("button[type='submit']").textContent = 'Update product';
      marketplaceFormTitle.textContent = 'Edit marketplace product';
      showSection('marketplace');
    }

    function deleteMarketplaceItem(key) {
      if (confirm('Are you sure you want to delete this product?')) {
        firebase.database().ref('marketplace/' + key).remove().then(() => {
          showToast('üóëÔ∏è Product deleted');
        });
      }
    }

    function loadQuestConfig() {
      const ref = firebase.database().ref('questConfig');
      ref.once('value').then(snap => {
        const cfg = snap.val() || {};
        document.getElementById('openPacks-goal').value = cfg.openPacks?.goal || 0;
        document.getElementById('openPacks-reward').value = cfg.openPacks?.reward || 0;
        document.getElementById('spendCoins-goal').value = cfg.spendCoins?.goal || 0;
        document.getElementById('spendCoins-reward').value = cfg.spendCoins?.reward || 0;
        document.getElementById('pullRare-goal').value = cfg.pullRare?.goal || 0;
        document.getElementById('pullRare-reward').value = cfg.pullRare?.reward || 0;
      });
    }

    document.getElementById('quest-config-form').addEventListener('submit', e => {
      e.preventDefault();
      const config = {
        openPacks: {
          goal: parseInt(document.getElementById('openPacks-goal').value) || 0,
          reward: parseInt(document.getElementById('openPacks-reward').value) || 0
        },
        spendCoins: {
          goal: parseInt(document.getElementById('spendCoins-goal').value) || 0,
          reward: parseInt(document.getElementById('spendCoins-reward').value) || 0
        },
        pullRare: {
          goal: parseInt(document.getElementById('pullRare-goal').value) || 0,
          reward: parseInt(document.getElementById('pullRare-reward').value) || 0
        }
      };
      firebase.database().ref('questConfig').set(config).then(() => showToast('‚úÖ Quest config saved'));
    });

    function addWheelReward(reward = {}) {
      const div = document.createElement('div');
      div.className = 'p-4 glass-subcard space-y-3';
      div.innerHTML = `
        <div class="flex justify-between items-center">
          <span class="text-sm font-semibold text-white">${reward.label || 'Wheel reward'}</span>
          <button type="button" class="text-xs uppercase tracking-[0.3em] text-rose-300 hover:text-rose-200" onclick="this.closest('.glass-subcard').remove()">Remove</button>
        </div>
        <div class="grid gap-3 md:grid-cols-2">
          <div class="space-y-1">
            <span class="text-xs uppercase tracking-wide text-slate-400">Label</span>
            <input type="text" placeholder="Label" value="${reward.label || ''}" class="reward-label form-input">
          </div>
          <div class="space-y-1">
            <span class="text-xs uppercase tracking-wide text-slate-400">Amount</span>
            <input type="number" placeholder="Amount" value="${reward.amount || ''}" class="reward-amount form-input">
          </div>
          <div class="space-y-1">
            <span class="text-xs uppercase tracking-wide text-slate-400">Odds (%)</span>
            <input type="number" placeholder="Odds (%)" value="${reward.odds ?? reward.weight ?? 1}" class="reward-odds form-input">
          </div>
          <div class="space-y-1">
            <span class="text-xs uppercase tracking-wide text-slate-400">Color</span>
            <input type="color" value="${reward.color || '#3b82f6'}" class="reward-color h-11 w-full rounded-xl border border-slate-700/60 bg-transparent">
          </div>
          <div class="space-y-1 md:col-span-2">
            <span class="text-xs uppercase tracking-wide text-slate-400">Image URL</span>
            <input type="url" placeholder="Image URL" value="${reward.image || ''}" class="reward-image form-input">
          </div>
        </div>
        ${reward.image ? `<img src="${reward.image}" class="reward-preview w-32 h-32 object-contain mt-2 rounded-xl border border-slate-800/70" />` : ''}
      `;
      const input = div.querySelector('.reward-image');
      input.addEventListener('input', e => {
        const url = e.target.value.trim();
        let img = div.querySelector('.reward-preview');
        if (url) {
          if (!img) {
            img = document.createElement('img');
            img.className = 'reward-preview w-32 h-32 object-contain mt-2 rounded-xl border border-slate-800/70';
            input.insertAdjacentElement('afterend', img);
          }
          img.src = url;
        } else if (img) {
          img.remove();
        }
      });
      document.getElementById('wheel-rewards').appendChild(div);
    }

    function loadWheelRewards() {
      const ref = firebase.database().ref('wheelRewards');
      ref.on('value', snap => {
        const container = document.getElementById('wheel-rewards');
        container.innerHTML = '';
        Object.values(snap.val() || {}).forEach(r => addWheelReward(r));
      });
    }

    document.getElementById('add-reward').addEventListener('click', () => addWheelReward());

    document.getElementById('wheel-form').addEventListener('submit', e => {
      e.preventDefault();
      const blocks = Array.from(document.querySelectorAll('#wheel-rewards .glass-subcard'));
      const rewards = [];
      for (const div of blocks) {
        const image = div.querySelector('.reward-image').value.trim();
        const reward = {
          label: div.querySelector('.reward-label').value,
          amount: parseInt(div.querySelector('.reward-amount').value) || 0,
          color: div.querySelector('.reward-color').value,
          odds: parseFloat(div.querySelector('.reward-odds').value) || 0,
          image
        };
        if (reward.label && reward.image) rewards.push(reward);
      }
      firebase.database().ref('wheelRewards').set(rewards).then(() => showToast('‚úÖ Rewards saved'));
    });

    document.getElementById('clear-battles').addEventListener('click', () => {
      firestore.collection('battles').get().then(snap => {
        const batch = firestore.batch();
        snap.forEach(doc => {
          if ((doc.data().status || '') !== 'finished') batch.delete(doc.ref);
        });
        return batch.commit();
      }).then(() => showToast('‚úÖ Battles cleared'));
    });

    function loadUserCount() {
      firebase.database().ref('users').once('value').then(snapshot => {
        setStat('totalUsers', snapshot.numChildren());
      });
    }
  </script>

</body>
</html>
