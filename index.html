<<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PrimePull.gg | Open Cases and Win</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #0f0f12; color: white; }
    .case-card-img { height: 200px; width: 100%; object-fit: cover; border-radius: 8px; }
    .fade { transition: opacity 0.5s ease; }
    .marquee { display: flex; overflow: hidden; white-space: nowrap; }
    .marquee-content { display: inline-block; animation: marquee 20s linear infinite; }
    @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-10px); } 40% { transform: translateX(10px); } 60% { transform: translateX(-10px); } 80% { transform: translateX(10px); } }
    .animate-shake { animation: shake 0.6s; }
  </style>
</head>
<body>

<!-- Your HTML content remains unchanged -->
<!-- Skip to scripts for key fixes -->

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// Firebase Setup
const firebaseConfig = {
  apiKey: "AIzaSyCyRm6dWH-fAmfWy83zLTrPFVi9Ny8gyxE",
  authDomain: "cases-e5b4e.firebaseapp.com",
  databaseURL: "https://cases-e5b4e-default-rtdb.firebaseio.com",
  projectId: "cases-e5b4e",
  storageBucket: "cases-e5b4e.appspot.com",
  messagingSenderId: "22502548396",
  appId: "1:22502548396:web:aac335672c21f07524d009"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const authButton = document.getElementById('auth-button');
const userBalanceDiv = document.getElementById('user-balance');
const topupPopup = document.getElementById('topup-popup');
const closeTopup = document.getElementById('close-topup');
const casesContainer = document.getElementById('cases-container');
const recentWins = document.getElementById('recent-wins');
const popup = document.getElementById('case-popup');
const openCaseButton = document.getElementById('open-case-button');
const caseImage = document.getElementById('case-main-image');
const caseImageWrapper = document.getElementById('case-image');
const resultDiv = document.getElementById('result');
const possiblePrizesDiv = document.getElementById('possible-prizes');
let selectedCaseId = null;
let selectedCasePrice = 0;
let currentPrizes = [];

function addCoins(amount) {
  const user = firebase.auth().currentUser;
  if (!user) return alert('You must be logged in.');
  const userRef = db.ref('users/' + user.uid);
  userRef.once('value').then(snapshot => {
    const currentBalance = snapshot.val().balance || 0;
    const newBalance = currentBalance + amount;
    userRef.update({ balance: newBalance }).then(() => {
      document.getElementById('balance-amount').innerText = newBalance;
      topupPopup.classList.add('hidden');
    });
  });
}

function loadCases() {
  db.ref('cases').on('value', snapshot => {
    casesContainer.innerHTML = '';
    snapshot.forEach(child => {
      const data = child.val();
      casesContainer.innerHTML += `
        <div class="p-4 bg-gray-800 rounded-lg">
          <img src="${data.image}" class="case-card-img">
          <h3 class="mt-2 font-semibold">${data.name}</h3>
          <p class="text-sm text-gray-400 mb-2">$${data.price || '0.00'}</p>
          <button class="mt-2 w-full py-2 bg-gradient-to-r from-purple-600 to-pink-500 rounded open-case glow-button" data-id="${child.key}">Open Pack</button>
        </div>`;
    });
    document.querySelectorAll('.open-case').forEach(btn => {
      btn.onclick = openCasePopup;
    });
  });
}

function loadRecentWins() {
  db.ref('recentWins').on('value', snapshot => {
    recentWins.innerHTML = '';
    snapshot.forEach(child => {
      const win = child.val();
      recentWins.innerHTML += `
        <div class="flex items-center space-x-2">
          <img src="${win.image}" class="h-8 w-8 rounded-full object-cover">
          <span>${win.name}</span>
        </div>`;
    });
  });
}

function openCasePopup(e) {
  const caseId = e.target.dataset.id;
  selectedCaseId = caseId;
  db.ref('cases/' + caseId).once('value').then(snapshot => {
    const data = snapshot.val();
    selectedCasePrice = parseFloat(data.price) || 0;
    document.getElementById('case-price').dataset.price = selectedCasePrice;
    caseImage.src = data.image;
    currentPrizes = Object.values(data.prizes || {});
    possiblePrizesDiv.innerHTML = currentPrizes.map(prize => `
      <div class="text-center">
        <img src="${prize.image}" class="h-16 mx-auto object-contain">
        <p class="text-sm">${prize.name} (${prize.rarity || 'Unknown'})</p>
      </div>`).join('');
    resultDiv.classList.add('hidden');
    popup.classList.remove('hidden');
  });
}

document.getElementById('close-popup').onclick = () => popup.classList.add('hidden');

openCaseButton.onclick = () => {
  const user = firebase.auth().currentUser;
  if (!user) return alert('Please sign in first!');
  if (!selectedCaseId || selectedCasePrice === 0) return alert('No case selected or invalid case price.');
  const userRef = db.ref('users/' + user.uid);
  userRef.once('value').then(userSnap => {
    const userData = userSnap.val() || {};
    const userBalance = parseFloat(userData.balance || 0);
    if (userBalance < selectedCasePrice) {
      alert('Insufficient balance.');
      return;
    }
    const newBalance = userBalance - selectedCasePrice;
    userRef.update({ balance: newBalance }).then(() => {
      document.getElementById('balance-amount').innerText = newBalance;
      caseImageWrapper.classList.add('animate-shake');
      setTimeout(() => {
        caseImageWrapper.classList.remove('animate-shake');
        const winningPrize = currentPrizes[Math.floor(Math.random() * currentPrizes.length)];
        caseImage.src = winningPrize.image;
        resultDiv.innerHTML = `ðŸŽ‰ You won: <span>${winningPrize.name} (${winningPrize.rarity || 'Unknown'})</span> ðŸŽ‰`;
        resultDiv.classList.remove('hidden');
        confetti({ particleCount: 120, spread: 70, origin: { y: 0.6 } });
      }, 1000);
    });
  });
};

closeTopup.onclick = () => topupPopup.classList.add('hidden');

window.onload = () => {
  loadCases();
  loadRecentWins();
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      const userRef = db.ref('users/' + user.uid);
      userRef.once('value').then(snapshot => {
        if (!snapshot.exists()) userRef.set({ balance: 0 });
        const userData = snapshot.val() || { balance: 0 };
        userBalanceDiv.innerHTML = `
          <img src="https://cdn-icons-png.flaticon.com/128/6369/6369589.png" class="inline-block mr-2" width="18" height="18">
          <span id="balance-amount">${userData.balance}</span> coins
          <button id="topup-button" class="text-green-400 text-2xl hover:text-green-500 ml-2">+</button>`;
        userBalanceDiv.classList.remove('hidden');
        document.getElementById('topup-button').onclick = () => topupPopup.classList.remove('hidden');
        authButton.innerText = 'Logout';
        authButton.href = '#';
        authButton.onclick = (e) => {
          e.preventDefault();
          firebase.auth().signOut().then(() => location.reload());
        };
      });
    } else {
      userBalanceDiv.classList.add('hidden');
      authButton.innerText = 'Sign In';
      authButton.href = 'auth.html';
    }
  });
};
</script>

</body>
</html>
