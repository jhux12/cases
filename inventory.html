<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PrimePull.gg | Inventory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCyRm6dWH-fAmfWy83zLTrPFVi9Ny8gyxE",
      authDomain: "cases-e5b4e.firebaseapp.com",
      databaseURL: "https://cases-e5b4e-default-rtdb.firebaseio.com",
      projectId: "cases-e5b4e",
      storageBucket: "cases-e5b4e.appspot.com",
      messagingSenderId: "22502548396",
      appId: "1:22502548396:web:aac335672c21f07524d009"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f0f12; color: white; }
    .inventory-card { background: #1f1f24; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">My Inventory</h1>
    <div id="inventory-list" class="space-y-4"></div>
    <div class="mt-6">
      <button onclick="openShipmentPopup()" class="bg-pink-600 hover:bg-pink-700 text-white px-6 py-2 rounded">
        Request Shipment
      </button>
    </div>
  </div>

  <!-- Shipment Popup -->
  <div id="shipment-popup" class="fixed inset-0 bg-black bg-opacity-80 hidden flex justify-center items-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md">
      <h2 class="text-xl font-bold mb-4">Enter Shipping Info</h2>
      <input id="ship-name" type="text" placeholder="Full Name" class="w-full mb-2 px-4 py-2 rounded bg-gray-700" />
      <input id="ship-address" type="text" placeholder="Address" class="w-full mb-2 px-4 py-2 rounded bg-gray-700" />
      <input id="ship-city" type="text" placeholder="City" class="w-full mb-2 px-4 py-2 rounded bg-gray-700" />
      <input id="ship-zip" type="text" placeholder="Zip Code" class="w-full mb-4 px-4 py-2 rounded bg-gray-700" />
      <p id="shipment-cost" class="text-sm text-gray-300 mb-4"></p>
      <div class="flex justify-end gap-4">
        <button onclick="closeShipmentPopup()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded">Cancel</button>
        <button onclick="submitShipmentRequest()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    const db = firebase.database();
    const inventoryList = document.getElementById('inventory-list');
    let selectedItems = [];

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        const userRef = db.ref('users/' + user.uid);
        userRef.child('inventory').on('value', snapshot => {
          inventoryList.innerHTML = '';
          snapshot.forEach(child => {
            const item = child.val();
            const div = document.createElement('div');
            div.className = 'inventory-card';
            div.innerHTML = `
              <div class="flex justify-between items-center">
                <div>
                  <p class="font-semibold">${item.name}</p>
                  <p class="text-sm text-gray-400">${item.rarity}</p>
                  <p class="text-sm text-${item.shipped ? 'green' : 'yellow'}-400 font-medium">
                    ${item.shipped ? 'Shipped' : item.requested ? 'Pending Approval' : 'Not Requested'}
                  </p>
                </div>
                <div class="flex gap-2 items-center">
                  <img src="${item.image}" class="h-16 rounded" />
                  <input type="checkbox" value="${child.key}" onchange="toggleItem(this, ${item.value || 0}, '${item.name}', '${item.image}')">
                </div>
              </div>`;
            inventoryList.appendChild(div);
          });
        });
      } else {
        alert('Please sign in to view your inventory.');
        window.location.href = 'auth.html';
      }
    });

    function toggleItem(checkbox, value, name, image) {
      if (checkbox.checked) {
        selectedItems.push({ id: checkbox.value, value, name, image });
      } else {
        selectedItems = selectedItems.filter(item => item.id !== checkbox.value);
      }
    }

    function openShipmentPopup() {
      if (selectedItems.length === 0) return alert('Please select items to ship.');
      const cost = selectedItems.length <= 5 ? selectedItems.length * 500 : 2500;
      document.getElementById('shipment-cost').innerText = `Shipping ${selectedItems.length} item(s) will cost ${cost} coins.`;
      document.getElementById('shipment-popup').classList.remove('hidden');
    }

    function closeShipmentPopup() {
      document.getElementById('shipment-popup').classList.add('hidden');
    }

    function submitShipmentRequest() {
      const user = firebase.auth().currentUser;
      if (!user) return alert('Please sign in.');

      const name = document.getElementById('ship-name').value.trim();
      const address = document.getElementById('ship-address').value.trim();
      const city = document.getElementById('ship-city').value.trim();
      const zip = document.getElementById('ship-zip').value.trim();

      if (!name || !address || !city || !zip) return alert('Please fill in all shipping details.');

      const cost = selectedItems.length <= 5 ? selectedItems.length * 500 : 2500;
      const userRef = db.ref('users/' + user.uid);

      userRef.once('value').then(snapshot => {
        const balance = snapshot.val().balance || 0;
        if (balance < cost) {
          alert(`Insufficient balance. You need ${cost} coins.`);
          return;
        }

        userRef.update({ balance: balance - cost });

        selectedItems.forEach(item => {
          db.ref('shipments').push({
            userId: user.uid,
            itemId: item.id,
            name: item.name,
            image: item.image,
            shippingInfo: { name, address, city, zip },
            status: 'Requested',
            timestamp: Date.now()
          });

          db.ref('users/' + user.uid + '/inventory/' + item.id).update({ requested: true });
        });

        alert('ðŸ“¦ Shipment requested!');
        selectedItems = [];
        closeShipmentPopup();
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      });
    }
  </script>
</body>
</html>
