<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Packly.gg | Case Opening</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <!-- Your config file -->
  <script src="./scripts/firebase-config.js"></script>

  <!-- Optional styles -->
  <link rel="stylesheet" href="styles/main.css">
</head>
<body class="bg-black text-white">
  <section class="container mx-auto px-4 py-8">
    <div class="text-center">
      <h2 id="case-name" class="text-3xl font-bold">Loading...</h2>
      <p id="user-balance" class="mt-2 text-sm">Balance: <span id="balance-value" class="text-yellow-400">... coins</span></p>
      <button id="refresh-balance" class="text-blue-400 text-xs underline">Refresh</button>
      <p class="text-yellow-300 mt-2" id="case-price">Price: <span id="case-price-amount">...</span></p>
    </div>

    <div class="my-8 border border-white/10 rounded-lg bg-black/20">
      <div class="relative h-[200px] overflow-hidden">
        <div id="center-line" class="absolute top-0 bottom-0 w-1 bg-pink-500 left-1/2 transform -translate-x-1/2 z-10"></div>
        <div id="spinner-container" class="w-full h-full"></div>
      </div>
    </div>

    <div class="text-center">
      <button id="open-case-button" class="px-6 py-3 rounded-full bg-gradient-to-r from-yellow-400 via-pink-500 to-purple-500 text-white font-extrabold">Open Case</button>
    </div>

    <div class="mt-10 bg-black/30 p-6 rounded-lg border border-white/10">
      <h3 class="text-xl font-bold text-center">Rewards</h3>
      <div id="prizes-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-4"></div>
    </div>
  </section>

  <!-- Main logic -->
  <script>
    const formatCoins = (num) => {
      if (num >= 1_000_000) return (num / 1_000_000).toFixed(1) + "M";
      if (num >= 1_000) return (num / 1_000).toFixed(1) + "K";
      return num.toLocaleString();
    };

    const updateUserBalance = () => {
      const user = firebase.auth().currentUser;
      const el = document.getElementById("balance-value");
      if (!user || !el) return;

      firebase.database().ref("users/" + user.uid).once("value").then((snap) => {
        const balance = snap.val()?.balance || 0;
        el.textContent = `${parseFloat(balance).toLocaleString()} coins`;
      }).catch((error) => {
        el.textContent = "error";
        console.error(error);
      });
    };

    const rarityOrder = { legendary: 5, "ultra rare": 4, rare: 3, uncommon: 2, common: 1 };

    document.addEventListener("DOMContentLoaded", () => {
      const refreshBtn = document.getElementById("refresh-balance");
      if (refreshBtn) refreshBtn.addEventListener("click", updateUserBalance);

      const user = firebase.auth().currentUser;
      if (!user) {
        document.getElementById("user-balance").textContent = "Balance: Sign in required";
      } else {
        updateUserBalance();
      }
    });

    firebase.auth().onAuthStateChanged((user) => {
      if (user) updateUserBalance();
      else document.getElementById("user-balance").textContent = "Balance: Sign in required";
    });

    const urlParams = new URLSearchParams(window.location.search);
    const caseId = urlParams.get("id");

    if (!caseId) {
      document.getElementById("case-name").innerText = "Case not found.";
    }

    firebase.database().ref("cases/" + caseId).once("value").then((snap) => {
      if (!snap.exists()) {
        document.getElementById("case-name").innerText = "Case not found.";
        return;
      }

      const caseData = snap.val();
      document.getElementById("case-name").innerText = caseData.name;
      document.getElementById("case-price-amount").textContent = `${formatCoins(caseData.price)} coins`;

      const prizeList = Object.values(caseData.prizes || {}).sort((a, b) => {
        return (rarityOrder[b.rarity?.toLowerCase()] || 0) - (rarityOrder[a.rarity?.toLowerCase()] || 0);
      });

      document.getElementById("prizes-grid").innerHTML = prizeList.map(prize => `
        <div class="rounded-xl p-3 text-white backdrop-blur-sm bg-white/10">
          <img src="${prize.image}" class="h-40 w-full object-contain mx-auto rounded-md mb-3" />
          <div class="text-center text-xs font-semibold">${prize.name}</div>
          <div class="text-yellow-300 text-center text-sm">${formatCoins(prize.value)} coins</div>
        </div>
      `).join("");

      document.getElementById("open-case-button").addEventListener("click", async () => {
        const user = firebase.auth().currentUser;
        if (!user) return alert("Please sign in to open cases.");

        const userSnap = await firebase.database().ref('users/' + user.uid).once("value");
        const balance = parseFloat(userSnap.val()?.balance || 0);
        const price = parseFloat(caseData.price || 0);

        if (balance < price) return alert("Not enough coins.");

        const fairSnap = await firebase.database().ref('users/' + user.uid + '/provablyFair').once("value");
        const fairData = fairSnap.val();
        if (!fairData) return alert("Provably fair data missing.");

        const { serverSeed, clientSeed, nonce } = fairData;
        const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(`${serverSeed}:${clientSeed}:${nonce}`));
        const hashHex = [...new Uint8Array(hashBuffer)].map(b => b.toString(16).padStart(2, '0')).join('');
        const rand = parseInt(hashHex.substring(0, 8), 16) / 0xffffffff;

        const prizes = Object.values(caseData.prizes || {}).sort((a, b) => a.odds - b.odds);
        const totalOdds = prizes.reduce((sum, p) => sum + (p.odds || 0), 0);

        let cumulative = 0;
        let winningPrize = prizes[prizes.length - 1];
        for (let p of prizes) {
          cumulative += p.odds || 0;
          if (rand * totalOdds < cumulative) {
            winningPrize = p;
            break;
          }
        }

        // OPTIONAL: Replace this with your actual spinner logic
        alert(`ðŸŽ‰ You won: ${winningPrize.name}`);

        await firebase.database().ref('users/' + user.uid + '/balance').set(balance - price);
        await firebase.database().ref('users/' + user.uid + '/inventory').push({
          name: winningPrize.name,
          image: winningPrize.image,
          rarity: winningPrize.rarity,
          value: winningPrize.value,
          timestamp: Date.now()
        });
        await firebase.database().ref('users/' + user.uid + '/provablyFair').update({ nonce: nonce + 1 });
        updateUserBalance();
      });
    });
  </script>
</body>
</html>
