<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Packly.gg | Case Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="scripts/firebase-config.js"></script>
  <link rel="stylesheet" href="styles/main.css">
  <audio id="pack-open-sound" src="https://firebasestorage.googleapis.com/v0/b/cases-e5b4e.firebasestorage.app/o/common.wav?alt=media&token=98a37c37-e55d-4440-8b2b-c4b40a444dc5"></audio>
  <style>
.glow-common    { box-shadow: 0 0 30px #a1a1aa; }
.glow-uncommon  { box-shadow: 0 0 30px #4ade80; }
.glow-rare      { box-shadow: 0 0 30px #60a5fa; }
.glow-ultra     { box-shadow: 0 0 30px #c084fc; }
.glow-legendary { box-shadow: 0 0 40px #facc15; }

  .updates-bar {
    background: linear-gradient(to right, #facc15, #ec4899, #8b5cf6);
    color: white;
    padding: 0.5rem;
    border-radius: 1rem;
    font-weight: 500;
    overflow: hidden;
    white-space: nowrap;
    animation: marquee 20s linear infinite;
    box-shadow: 0 4px 20px rgba(255, 255, 255, 0.15);
  }
  @keyframes marquee {
    0% { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
  }
  .marquee-text {
    display: inline-block;
    padding-left: 100%;
    animation: marquee 20s linear infinite;
  }
    .perspective {
  perspective: 1000px;
}
.transform-style-preserve-3d {
  transform-style: preserve-3d;
}
.backface-hidden {
  backface-visibility: hidden;
}
.rotate-y-180 {
  transform: rotateY(180deg);
}
.flipped {
  transform: rotateY(180deg);
}
#flip-card-inner {
  transition: transform 2s;
  transform-style: preserve-3d;
}

#flip-card-inner.flipped {
  transform: rotateY(180deg);
}
  #prizes-grid > div {
  box-shadow: 0 4px 20px rgba(255, 255, 255, 0.05);
}
.card-gradient-common {
  background: linear-gradient(180deg, rgba(63, 63, 70, 0.7), rgba(82, 82, 91, 0.7));
}
.card-gradient-uncommon {
  background: linear-gradient(180deg, rgba(20, 83, 45, 0.7), rgba(34, 197, 94, 0.7));
}
.card-gradient-rare {
  background: linear-gradient(180deg, rgba(30, 64, 175, 0.7), rgba(59, 130, 246, 0.7));
}
.card-gradient-ultrarare {
  background: linear-gradient(180deg, rgba(107, 33, 168, 0.7), rgba(168, 85, 247, 0.7));
}
.card-gradient-legendary {
  background: linear-gradient(180deg, rgba(133, 77, 14, 0.7), rgba(250, 204, 21, 0.7));
}


</style>

</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-black text-white">

<header></header>

<!-- Hero Section -->
<section class="pt-20 pb-12 px-6 bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900">
  <div class="container mx-auto max-w-4xl text-center">
    <h1 class="text-4xl md:text-5xl font-extrabold mb-4 text-white tracking-tight leading-tight">
      üéÅ Case Details
    </h1>
    <p class="text-md md:text-lg text-gray-300 mb-6 leading-relaxed">
      View the possible rewards and open your pack!
    </p>
  </div>
</section>

  <!-- Main Content Section -->
<section id="case-content" class="py-10 px-4 max-w-5xl mx-auto">
  <div id="case-container" class="bg-black/20 rounded-2xl border border-white/10 p-6 shadow-lg backdrop-blur-md text-center">

   <!-- Case Thumbnail + Title -->
<div class="mb-8 relative flex flex-col items-center justify-center">
  <!-- Flip Card (initially hidden) -->
  <div id="flip-card" class="relative w-40 h-64 sm:w-48 sm:h-72 perspective hidden">
 <div id="flip-card-inner" class="relative w-full h-full transition-transform duration-[2000ms] transform-style-preserve-3d">
      <!-- Back of the card (winning prize) -->
<img id="flip-back" src="" class="absolute w-full h-full rounded-xl object-contain backface-hidden rotate-y-180" alt="Back" />
<!-- Front of the card (case image) -->
<img id="flip-front" src="" class="absolute w-full h-full rounded-xl object-contain backface-hidden z-10" alt="Front" />

    </div>
  </div>

  <!-- Static Case Image -->
  <img id="case-image" src="" alt="Case Image" class="w-40 h-64 sm:w-48 sm:h-72 mx-auto rounded-xl shadow-lg object-contain ring-2 ring-white/10">
  
  <h2 id="case-name" class="mt-4 text-3xl font-bold text-white">Loading...</h2>
  <p id="case-price" class="mt-1 text-sm text-yellow-300 flex justify-center items-center gap-1">
  <p id="user-balance" class="text-xs text-gray-400 mt-1">Balance: ... coins</p>
  <img src="https://cdn-icons-png.flaticon.com/128/6369/6369589.png" alt="Coin" class="w-4 h-4 inline-block">
  0 coins
</p>
</div>


    <!-- Open Button -->
   <button id="open-case-button" class="relative mb-10 px-6 py-3 rounded-full bg-gradient-to-r from-yellow-400 via-pink-500 to-purple-500 text-white font-extrabold text-sm uppercase tracking-wide shadow-lg hover:scale-105 transition-transform duration-200">
  <span id="open-button-text">Open for ...</span>
</button>

<div class="mt-2 flex items-center justify-center gap-2 text-xs text-gray-400">
 <div class="relative flex justify-center">
    <div id="provably-fair-badge" class="flex items-center text-sm text-green-400 font-semibold cursor-pointer">
      <i class="fas fa-shield-alt mr-2 text-green-400"></i> Provably Fair
    </div>
    <div id="fair-tooltip" class="absolute top-full mt-2 bg-gray-800 text-white text-xs rounded-lg px-4 py-2 shadow-lg hidden z-50 w-64 text-center left-1/2 transform -translate-x-1/2">
      Each result is generated using a hashed server seed + your client seed and nonce. You can verify fairness anytime.
    </div>
  </div>
</div>


    <!-- Possible Rewards Header -->
<div class="text-center mb-6">
  <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-yellow-400 via-pink-500 to-purple-500 shadow-md">
    <img src="https://cdn-icons-png.flaticon.com/512/1039/1039542.png" alt="Rewards Icon" class="w-5 h-5" />
    <span class="text-sm font-bold uppercase tracking-wider text-white">Possible Rewards</span>
  </div>
  <p class="mt-2 text-sm text-gray-300">Each case contains a mix of prizes with different rarities and values.</p>
</div>
    <div id="prizes-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6 text-sm"></div>
  </div>
</section>

<script type="module">
  function formatCoins(num) {
  if (num >= 1_000_000) return (num / 1_000_000).toFixed(1) + "M";
  if (num >= 1_000) return (num / 1_000).toFixed(1) + "K";
  return num.toLocaleString();
}

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCyRm6dWH8b_BZ0oImEBPW_T3sF14Tz8dE",
    authDomain: "cases-e5b4e.firebaseapp.com",
    databaseURL: "https://cases-e5b4e-default-rtdb.firebaseio.com",
    projectId: "cases-e5b4e",
    storageBucket: "cases-e5b4e.appspot.com",
    messagingSenderId: "1094023497986",
    appId: "1:1094023497986:web:59e018f1aa5e8c4093d7a5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const urlParams = new URLSearchParams(window.location.search);
  const caseId = urlParams.get('id');

  if (!caseId) {
    document.getElementById("case-name").innerText = "Case not found.";
    throw new Error("No case ID provided.");
  }

  const rarityOrder = {
    "legendary": 5,
    "ultra rare": 4,
    "rare": 3,
    "uncommon": 2,
    "common": 1
  };

  const rarityColors = {
    "legendary": "ring-yellow-400 glow-legendary text-yellow-400",
    "ultra rare": "ring-purple-500 text-purple-400",
    "rare": "ring-blue-500 text-blue-400",
    "uncommon": "ring-green-500 text-green-400",
    "common": "ring-gray-400 text-gray-300"
  };

  get(ref(db, `cases/${caseId}`)).then(snapshot => {
    if (!snapshot.exists()) {
      document.getElementById("case-name").innerText = "Case not found.";
      return;
    }

    const caseData = snapshot.val();

    document.getElementById("case-image").src = caseData.image;
    document.getElementById("case-name").innerText = caseData.name;
    document.getElementById("case-price").innerHTML = `
      <img src="https://cdn-icons-png.flaticon.com/128/6369/6369589.png" class="w-4 h-4 inline-block"> 
      ${parseFloat(caseData.price || 0).toLocaleString()} coins
    `;

    const prizeList = Object.values(caseData.prizes || {}).sort((a, b) => {
      return (rarityOrder[b.rarity?.toLowerCase()] || 0) - (rarityOrder[a.rarity?.toLowerCase()] || 0);
    });

    const prizeHTML = prizeList.map(prize => {
  const rarity = (prize.rarity || "common").toLowerCase().replace(" ", "");
  const glowClass = `glow-${rarity}`;
  const gradientClass = `card-gradient-${rarity}`;
  const valueFormatted = formatCoins(prize.value || 0);

  return `
    <div class="rounded-xl p-3 text-white cursor-pointer transition-all duration-300 transform hover:scale-105 backdrop-blur-sm bg-white/10 ${gradientClass}" onclick="expandPrize('${prize.image}')">
      <img src="${prize.image}" class="h-40 w-full object-contain mx-auto rounded-md mb-3 shadow-md ring-2 ring-white/10" />
      
      <div class="font-semibold text-center text-base">${prize.name}</div>

      <div class="flex justify-between items-center text-xs mt-2 font-semibold">
        <div class="flex items-center gap-1 text-yellow-300 font-bold">
          <img src="https://cdn-icons-png.flaticon.com/128/6369/6369589.png" class="w-4 h-4" />
          ${valueFormatted} coins
        </div>
        <div class="text-white/70 font-medium">${(prize.odds || 0).toFixed(1)}%</div>
      </div>
    </div>
  `;
}).join("");


    document.getElementById("prizes-grid").innerHTML = prizeHTML;


    // ‚úÖ Add click logic for open button
  document.getElementById("open-case-button").addEventListener("click", async () => {
    const openBtn = document.getElementById("open-case-button");
openBtn.disabled = true;
openBtn.classList.add("opacity-50", "cursor-not-allowed");

setTimeout(() => {
  openBtn.disabled = false;
  openBtn.classList.remove("opacity-50", "cursor-not-allowed");
}, 10000);

  const user = firebase.auth().currentUser;
  if (!user) return alert("Please sign in first!");

  const casePrice = parseFloat(caseData.price || 0);
  const userRef = ref(db, 'users/' + user.uid);
  const userSnap = await get(userRef);
  const balance = parseFloat(userSnap.val()?.balance || 0);
  document.getElementById("user-balance").innerText = `Balance: ${balance.toLocaleString()} coins`;
  if (balance < casePrice) return alert("Not enough coins!");

  const fairSnap = await get(ref(db, `users/${user.uid}/provablyFair`));
  const fairData = fairSnap.val();
    const pfDiv = document.createElement("div");
pfDiv.className = "text-xs text-gray-400 mt-4";
pfDiv.innerHTML = `
  <div class="mt-2">
    üîê Provably Fair Info:<br>
    Server Seed: <code>${fairData.serverSeed}</code><br>
    Client Seed: <code>${fairData.clientSeed}</code><br>
    Nonce: <code>${fairData.nonce}</code><br>
    <button id="change-seed" class="mt-1 text-sm text-blue-400 underline">Change Client Seed</button>
  </div>
`;
document.getElementById("case-container").appendChild(pfDiv);

document.getElementById("change-seed").addEventListener("click", async () => {
  const newSeed = prompt("Enter new client seed:");
  if (newSeed) {
    await firebase.database().ref('users/' + firebase.auth().currentUser.uid + '/provablyFair/clientSeed').set(newSeed);
    alert("‚úÖ New client seed saved! Reload to use it.");
  }
});

  if (!fairData || !fairData.serverSeed || !fairData.clientSeed || typeof fairData.nonce !== 'number') {
    return alert('Missing provably fair data.');
  }

  const { serverSeed, clientSeed, nonce } = fairData;
  const hash = await sha256(`${serverSeed}:${clientSeed}:${nonce}`);
  const rand = parseInt(hash.substring(0, 8), 16) / 0xffffffff;

  const prizes = Object.values(caseData.prizes || {}).sort((a, b) => a.odds - b.odds);
  const totalOdds = prizes.reduce((sum, p) => sum + (p.odds || 0), 0);

  let cumulative = 0;
  let winningPrize = prizes[prizes.length - 1]; // fallback

  for (let p of prizes) {
    cumulative += p.odds || 0;
    if (rand * totalOdds < cumulative) {
      winningPrize = p;
      break;
    }
  }

  // üí∞ Deduct balance
  await firebase.database().ref('users/' + user.uid + '/balance').set(balance - casePrice);

  // üíæ Save prize to inventory
  await firebase.database().ref('users/' + user.uid + '/inventory').push({
    name: winningPrize.name,
    image: winningPrize.image,
    rarity: winningPrize.rarity,
    value: winningPrize.value,
    timestamp: Date.now()
  });

  // üîÑ Update nonce
  await firebase.database().ref('users/' + user.uid + '/provablyFair').update({ nonce: nonce + 1 });

 // Play sound
document.getElementById("pack-open-sound").play().catch(() => {});

// Hide static image and show flip card
document.getElementById("case-image").classList.add("hidden");
document.getElementById("flip-card").classList.remove("hidden");

// Set front/back images
document.getElementById("flip-front").src = caseData.image;
document.getElementById("flip-back").src = winningPrize.image;

// Set rarity glow after flip completes
const rarityGlowMap = {
  "common": "glow-common",
  "uncommon": "glow-uncommon",
  "rare": "glow-rare",
  "ultra rare": "glow-ultra",
  "legendary": "glow-legendary"
};
const card = document.getElementById("flip-card");
card.classList.remove("glow-common", "glow-uncommon", "glow-rare", "glow-ultra", "glow-legendary");
setTimeout(() => {
  card.classList.add(rarityGlowMap[winningPrize.rarity?.toLowerCase()] || "glow-common");
}, 2000);

// Flip logic
const flipInner = document.getElementById("flip-card-inner");
flipInner.classList.remove("flipped"); // reset
void flipInner.offsetWidth;            // force reflow
flipInner.classList.add("flipped");    // flip

// Flip back after 6s
setTimeout(() => {
  flipInner.classList.remove("flipped");

  // Hide glow and flip card, show static image
  card.classList.remove("glow-common", "glow-uncommon", "glow-rare", "glow-ultra", "glow-legendary");
  document.getElementById("flip-card").classList.add("hidden");
  document.getElementById("case-image").classList.remove("hidden");
}, 6000);


  // üéâ Show result
  let resultDiv = document.getElementById("result-message");
if (!resultDiv) {
  resultDiv = document.createElement("div");
  resultDiv.id = "result-message";
  resultDiv.className = "mt-4 text-xl font-bold text-white";
  document.getElementById("case-container").appendChild(resultDiv);
}
resultDiv.innerHTML = `üéâ You won <span class="text-yellow-400">${winningPrize.name}</span> (${winningPrize.rarity})!`;


    });
  });
</script>


</style>

<!-- Updates Bar -->
<div class="updates-bar text-sm">
  <div class="marquee-text">
    üì¶ All cards are near mint unless specified otherwise ‚Äî ü™ô Sell back unwanted cards for coins üí∞
  </div>
</div>

<!-- Toast Notification -->
<div id="inventory-toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg text-center font-semibold hidden z-[9999]">
  Item added to inventory: <span id="toast-item-name"></span>
</div>

<!-- Expandable Image Overlay -->
<div id="prize-overlay" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[100]" onclick="this.classList.add('hidden')">
  <div class="relative" onclick="event.stopPropagation()">
    <button onclick="document.getElementById('prize-overlay').classList.add('hidden')" class="absolute top-2 right-2 text-white text-xl bg-black/70 px-3 py-1 rounded-full z-10 hover:bg-pink-600 transition">&times;</button>
    <img id="overlay-image" src="" class="w-[300px] sm:w-[400px] rounded-lg shadow-lg border border-white/20 transition-all duration-300 scale-75 opacity-0 animate-overlay-zoom">
  </div>
</div>

<!-- Script for expanding prize image -->
<script>
  function expandPrize(imageUrl) {
    const overlay = document.getElementById('prize-overlay');
    const overlayImg = document.getElementById('overlay-image');
    if (overlay && overlayImg) {
      overlayImg.src = imageUrl;
      overlay.classList.remove('hidden');
      overlayImg.classList.remove('opacity-0', 'scale-75');
    }
  }
</script>
  <script>
  async function sha256(message) {
    const encoder = new TextEncoder();
    const data = encoder.encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    return [...new Uint8Array(hashBuffer)].map(b => b.toString(16).padStart(2, '0')).join('');
  }
  </script>
</body>
</html>
